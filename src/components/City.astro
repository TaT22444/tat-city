---
// Cityã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å®šç¾©
export interface Props {
  currentTown?: string;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æŒã¤ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å±•é–‹ï¼ˆçµ±åˆå¾Œã¯å¸¸ã«worksã‚¿ã‚¦ãƒ³ï¼‰
const { currentTown = 'works' } = Astro.props;

// ä½œå“ãƒ‡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
import { worksData } from '../data/worksData.js';
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
import { profileData } from '../data/profileData.js';
// ã‚¹ã‚¿ã‚¤ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import CityStyles from './CityStyles.astro';
// ã‚³ã‚¤ãƒ³ç”»åƒã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import coinImage from '../assets/object/coin.png';
// ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import sunIcon from '../assets/icon/solar_sun-linear.svg';
import moonIcon from '../assets/icon/basil_moon-outline.svg';
// ä½ç½®ãƒªã‚»ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import locationIcon from '../assets/icon/tabler_location.svg';

// Worksã‚¿ã‚¦ãƒ³ç”¨ã®ä¼šç¤¾ãƒªã‚¹ãƒˆï¼ˆãƒã‚¤ãƒ³ãƒˆåã« 'Co.' ã‚’ä»˜åŠ ï¼‰
const workNames: string[] = worksData.names;
const blogNames: string[] = [
  'ãƒ–ãƒ­ã‚°ã¯ã˜ã‚ã¾ã—ãŸ', 'UIãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚³ãƒ„', 'æœ€è¿‘èª­ã‚“ã æœ¬'
];
---

<CityStyles />
<div class="city">
  <!-- ã‚³ã‚¤ãƒ³æ•°è¡¨ç¤ºUIã¨ãƒœãƒ¼ãƒŠã‚¹ä¸­UIã®ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="coin-counter-wrapper">
    <div class="coin-counter" id="coinCounter">
      <img src={coinImage.src} alt="ã‚³ã‚¤ãƒ³" class="coin-icon" />
      <span class="coin-count-label">æ‰€æŒã‚³ã‚¤ãƒ³ : </span>
      <span class="coin-count-text" id="coinCountText">0</span>
    </div>
    
    <!-- ãƒœãƒ¼ãƒŠã‚¹ä¸­UI -->
    <div class="bonus-indicator" id="bonusIndicator" style="display: none;">
      <span class="bonus-label">ãƒœãƒ¼ãƒŠã‚¹ä¸­</span>
      <span class="bonus-time" id="bonusTime">5:00</span>
    </div>
  </div>
  
  <div class="city-view town-works" id="cityView">
    <div class="city-grid" id="cityGrid">
      <!-- ã‚°ãƒªãƒƒãƒ‰ï¼ˆåœ°é¢ï¼‰ -->
      <div class="ground"></div>
      
      {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ - worksã‚¿ã‚¦ãƒ³ã«çµ±åˆ */}
      <div class="point-bubble point-9 profile-item work-item" data-profile-point="true">
        <div 
          class="work-image profile-image-thumb"
          style={typeof profileData.image === 'object' && 'src' in profileData.image 
            ? `background-image: url(${profileData.image.src});` 
            : `background-image: url(${profileData.image});`}
        ></div>
        <div class="work-title">Profile</div>
      </div>

      <!-- ç©ºé–“ã«å¹ãå‡ºã—ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ  -->
      {/* ä½œå“ãƒã‚¤ãƒ³ãƒˆ - çµ±åˆå¾Œã¯å¸¸ã«è¡¨ç¤º */}
      {workNames.map((workName, index) => {
        const workImage = worksData.images[workName as keyof typeof worksData.images];
        const imageSrc = (workImage && typeof workImage === 'object' && 'src' in workImage) 
          ? workImage.src 
          : (typeof workImage === 'string' ? workImage : '');
        return (
          <div 
            class={`point-bubble point-${index + 1} work-item`} 
            data-work-name={workName}
          >
            <div 
              class="work-image" 
              style={imageSrc ? `background-image: url(${imageSrc});` : ''}
            ></div>
            <div class="work-title">{workName}</div>
      </div>
        );
      })}
      
      {/* ãƒœãƒ¼ãƒŠã‚¹ãƒãƒ£ãƒ³ã‚¹ãƒã‚¤ãƒ³ãƒˆ */}
      <div class="point-bubble point-10 ad-item" data-ad-point="true">
            <div class="ad-icon">ğŸ“¢</div>
            <div class="work-title">ãƒœãƒ¼ãƒŠã‚¹ãƒãƒ£ãƒ³ã‚¹</div>
      </div>

    </div>
    
    {/* ã‚³ã‚¤ãƒ³ - city-gridã®å¤–ã«ç§»å‹•ï¼ˆ3D transformã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã«ï¼‰ */}
    <div class="coins-container" id="coinsContainer"></div>
    
    <!-- äººã‚’é…ç½®ã™ã‚‹ -->
    <div class="person" id="mainPerson">
      <div class="person-body">
        <div class="person-head"></div>
        <div class="person-torso"></div>
        <div class="person-leg left"></div>
        <div class="person-leg right"></div>
        <div class="person-arm left"></div>
        <div class="person-arm right"></div>
      </div>
      <div class="person-shadow"></div>
    </div>
    
    <!-- ãƒã‚¤ãƒ³ãƒˆåè¡¨ç¤ºç”¨ã®è¦ç´  -->
    <div class="point-name-display" id="pointNameDisplay"></div>
    
    <!-- æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="controls">
      <!-- PCç”¨: WASDãƒœã‚¿ãƒ³ -->
      <div class="controls-desktop">
      <button id="w-btn">W</button>
      <div class="controls-row">
        <button id="a-btn">A</button>
        <button id="s-btn">S</button>
        <button id="d-btn">D</button>
        </div>
      </div>
      
      <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨: ä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ -->
      <div class="controls-mobile" id="virtualJoystick">
        <div class="joystick-base" id="joystickBase">
          <div class="joystick-stick" id="joystickStick"></div>
        </div>
      </div>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
    <div class="theme-switcher">
      <!-- ä½ç½®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ï¼ˆå·¦å´ï¼‰ -->
      <button id="reset-position" aria-label="ä½ç½®ãƒªã‚»ãƒƒãƒˆ">
        <div class="reset-icon">
          <img src={typeof locationIcon === 'string' ? locationIcon : locationIcon.src} alt="ä½ç½®ãƒªã‚»ãƒƒãƒˆ" />
        </div>
      </button>
      
      <!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ãƒœã‚¿ãƒ³ï¼ˆå³å´ï¼‰ -->
      <button id="theme-toggle" class="theme-toggle-btn" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">
        <div class="toggle-theme-icons">
          <img src={typeof sunIcon === 'string' ? sunIcon : sunIcon.src} alt="ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰" class="theme-icon-light" />
          <img src={typeof moonIcon === 'string' ? moonIcon : moonIcon.src} alt="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰" class="theme-icon-dark" />
        </div>
      </button>
    </div>
    
    {/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆ - worksã‚¿ã‚¦ãƒ³ã«çµ±åˆå¾Œã¯å¸¸ã«è¡¨ç¤º */}
      <div class="company-list">
      <h3>Portfolio</h3>
        <ul>
        {/* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æœ€åˆã«è¿½åŠ  */}
        <li class="company-item" data-profile-point="true">
          Profile
        </li>
        {/* ä½œå“ãƒªã‚¹ãƒˆ */}
          {workNames.map(name => (
          <li class="company-item" data-work-name={name}>
              {name} Co.
            </li>
          ))}
        </ul>
      </div>
    
    <!-- ã‚¿ã‚¦ãƒ³åãƒªã‚¹ãƒˆ - çµ±åˆå¾Œã¯å‰Šé™¤ã¾ãŸã¯ç°¡ç•¥åŒ– -->
    {/* ã‚¿ã‚¦ãƒ³ãƒªã‚¹ãƒˆã¯çµ±åˆã«ã‚ˆã‚Šä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤ */}
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
<div class="building-modal" id="buildingModal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Building Info</h2>
      <button class="close-button" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="modalContent"></div>
    </div>
  </div>
</div>

<!-- ä½œå“æƒ…å ±ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— - å·¦å´ã«è¡¨ç¤º -->
<div class="work-popup" id="workPopup">
  <div class="popup-header">
    <h3 id="popupTitle">Hamori Co.</h3>
    <button class="popup-close-button" aria-label="é–‰ã˜ã‚‹">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div class="popup-image-container">
    <img src="/assets/images/works/hamori_pop.png" alt="Hamori" class="work-image-hamori">
  </div>
  <div class="popup-body">
    <div class="popup-meta">
      <span id="popupType">UI/UX</span>
      <span id="popupScope">å€‹äººåˆ¶ä½œ</span>
      <span id="popupDuration">1é€±é–“</span>
    </div>
    <p id="popupDescription">Hamoriã®ç°¡å˜ãªèª¬æ˜æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚Hamoriã®ç°¡å˜ãªèª¬æ˜æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚Hamoriã®ç°¡å˜ãªèª¬æ˜æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚Hamoriã®ç°¡å˜ãªèª¬æ˜æ–‡ãŒå…¥ã‚Šã¾ã™ã€‚</p>
  </div>
  <div class="popup-coin-container">
    <div class="popup-coin-worksgain">
      <img src={coinImage.src} alt="ã‚³ã‚¤ãƒ³" class="coin-icon">
      <span class="popup-coin-worksgain-counter">30</span>
    </div>
    <div class="popup-coin-give">
      <button class="popup-coin-give-btn">
        <span class="popup-coin-give-btn-text">ã‚³ã‚¤ãƒ³ã§å¿œæ´</span>
        <img src={coinImage.src} alt="ã‚³ã‚¤ãƒ³" class="popup-coin-give-btn-icon">
        <span class="popup-coin-give-btn-text">-1</span>
      </button>
    </div>
  </div>
  <div class="popup-footer">
    <button class="popup-close-btn">é–‰ã˜ã‚‹</button>
    <a href="#" class="popup-more-btn" id="workPopupMoreBtn">è©³ç´°ã‚’è¦‹ã‚‹</a>
  </div>
</div>

<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— - å·¦å´ã«è¡¨ç¤º -->
<div class="profile-popup" id="profilePopup">
  <div class="popup-header">
    <h3 id="profilePopupTitle">ç›¸åŸç«‹å¼¥</h3>
    <button class="popup-close-button" aria-label="é–‰ã˜ã‚‹">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div class="popup-image-container">
    <img src={typeof profileData.image === 'object' && 'src' in profileData.image ? profileData.image.src : profileData.image} alt="ç›¸åŸç«‹å¼¥" class="profile-image-large">
  </div>
  <div class="popup-body">
    <div class="popup-meta">
      <span></span>
    </div>
    <p class="profile-popup-description" id="profilePopupDescription">{profileData.description}</p>
  </div>
  <div class="popup-coin-container">
    <div class="popup-coin-worksgain">
      <img src={coinImage.src} alt="ã‚³ã‚¤ãƒ³" class="coin-icon">
      <span class="popup-coin-worksgain-counter">30</span>
    </div>
    <div class="popup-coin-give">
      <button class="popup-coin-give-btn">
        <span class="popup-coin-give-btn-text">ã‚³ã‚¤ãƒ³ã§å¿œæ´</span>
        <img src={coinImage.src} alt="ã‚³ã‚¤ãƒ³" class="popup-coin-give-btn-icon">
        <span class="popup-coin-give-btn-text">-1</span>
      </button>
    </div>
  </div>
  <div class="popup-footer">
    <button class="popup-close-btn">é–‰ã˜ã‚‹</button>
    <button class="popup-more-btn">è©³ç´°ã‚’è¦‹ã‚‹</button>
  </div>
</div>

<!-- ãƒœãƒ¼ãƒŠã‚¹ãƒãƒ£ãƒ³ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="ad-popup" id="adPopup" style="display: none;">
  <div class="popup-header">
    <h3>ãƒœãƒ¼ãƒŠã‚¹ãƒãƒ£ãƒ³ã‚¹</h3>
    <button class="popup-close-button" aria-label="é–‰ã˜ã‚‹">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div class="popup-body">
    <div class="ad-prompt" id="adPrompt">
      <p>åºƒå‘Šã‚’è¦–è´ã™ã‚‹ã¨ã€5åˆ†é–“ã‚³ã‚¤ãƒ³å–å¾—æ•°ãŒ2å€ã«ãªã‚Šã¾ã™ï¼</p>
    </div>
    <div class="ad-container" id="adContainer" style="display: none;">
      {/* AdSenseåºƒå‘Šã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ åºƒå‘ŠãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ */}
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-4144123835991811"
           data-ad-slot="YOUR_AD_SLOT_ID"
           data-ad-format="auto"
           data-full-width-responsive="true"></ins>
    </div>
    <div class="custom-ad-container" id="customAdContainer" style="display: none;">
      {/* ã‚«ã‚¹ã‚¿ãƒ åºƒå‘Šï¼ˆè‡ªåˆ†ã®ä½œå“PRï¼‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ */}
    </div>
  </div>
  <div class="popup-footer">
    <button class="popup-close-btn" id="adCloseBtn">é–‰ã˜ã‚‹</button>
    <button class="ad-view-btn" id="adViewBtn">åºƒå‘Šã‚’è¦‹ã‚‹</button>
  </div>
</div>

<!-- ãƒ–ãƒ­ã‚°æƒ…å ±ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div class="work-popup" id="blogPopup" style="display: none;">
  <div class="popup-header">
    <h3 id="blogPopupTitle"></h3>
    <button class="popup-close-button" aria-label="é–‰ã˜ã‚‹">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div class="popup-image-container" id="blogPopupImage"></div>
  <div class="popup-body">
    <div class="popup-meta">
      <span id="blogPopupDate"></span>
      <span id="blogPopupCategory"></span>
    </div>
    <p id="blogPopupDescription"></p>
  </div>
  <div class="popup-footer">
    <button class="popup-close-btn">é–‰ã˜ã‚‹</button>
    <button class="popup-more-btn">ç¶šãã‚’èª­ã‚€</button>
  </div>
</div>

<!-- Google AdSense ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4144123835991811"
     crossorigin="anonymous"></script>

<!-- ãƒ†ãƒ¼ãƒåˆ‡æ›¿ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - ã‚ˆã‚Šç›´æ¥çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ -->
<script is:inline>
document.querySelector('#theme-toggle')?.addEventListener('click', function() {
  const html = document.documentElement;
  const isDark = html.classList.toggle('dark-theme');
  this.classList.toggle('dark-active', isDark);
  localStorage.setItem('cityTheme', isDark ? 'dark' : 'light');
});

// ä¿å­˜ã•ã‚ŒãŸãƒ†ãƒ¼ãƒã‚’é©ç”¨
if (localStorage.getItem('cityTheme') === 'dark') {
  document.documentElement.classList.add('dark-theme');
  document.querySelector('#theme-toggle')?.classList.add('dark-active');
}

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã¯onclickå±æ€§ã§å‡¦ç†

// Mobile Menu Toggle and Header scroll effect - PortfolioHeaderã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ç§»å‹•ã—ãŸãŸã‚å‰Šé™¤

</script>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script define:vars={{ profileData, worksData, coinImage }}>
  // ãƒ‡ãƒ¼ã‚¿ã¯Astroã®define:varsã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹
  // ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®ä¸€å…ƒç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã€é‡è¤‡ã‚’è§£æ¶ˆ
  
  // DOMè¦ç´ 
  let cityView = null;
  let cityGrid = null;
  let person = null;
  let buildingModal = null;
  let modalTitle = null;
  let modalContent = null;
  
  // çŠ¶æ…‹å¤‰æ•°
  let personX = 50; // åˆæœŸXä½ç½®ï¼ˆ%ï¼‰
  let personY = 70; // åˆæœŸYä½ç½®ï¼ˆ%ï¼‰
  const speed = 0.8; // ç§»å‹•é€Ÿåº¦ï¼ˆPCç”¨ï¼‰
  const touchSpeed = 0.28; // ã‚¿ãƒƒãƒæ“ä½œæ™‚ã®ç§»å‹•é€Ÿåº¦ï¼ˆã‚¹ãƒãƒ›ç”¨ã€å°‘ã—é€Ÿãèª¿æ•´ï¼‰
  const touchSpeedVertical = 0.22; // ç¸¦æ–¹å‘ï¼ˆç‰¹ã«ä¸Šæ–¹å‘ï¼‰ã®ç§»å‹•é€Ÿåº¦ï¼ˆå°‘ã—é€Ÿãèª¿æ•´ï¼‰
  let cameraX = 0;
  let cameraY = 0;
  let isMoving = false;
  let walkCycle = 0;
  let isZoomed = false; // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹ãƒ•ãƒ©ã‚°
  let zoomedPointName = null; // ã‚ºãƒ¼ãƒ ä¸­ã®ãƒã‚¤ãƒ³ãƒˆå
  let collidingWork = null; // è¡çªä¸­ã®ä½œå“å
  let isEventLocked = false; // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®æ“ä½œãƒ­ãƒƒã‚¯
  
  // ã‚³ã‚¤ãƒ³é–¢é€£ã®å¤‰æ•°
  let coinCount = 0; // æ‰€æŒã‚³ã‚¤ãƒ³æ•°
  const MAX_VISIBLE_COINS = 3; // ä¸€åº¦ã«è¡¨ç¤ºã™ã‚‹ã‚³ã‚¤ãƒ³ã®æœ€å¤§æ•°
  const COIN_RESPAWN_DELAY = 10000; // ã‚³ã‚¤ãƒ³ãŒå–å¾—ã•ã‚Œã¦ã‹ã‚‰æ–°ã—ã„ã‚³ã‚¤ãƒ³ãŒå‡ºç¾ã™ã‚‹ã¾ã§ã®æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  const coins = []; // ã‚³ã‚¤ãƒ³ã®ãƒ‡ãƒ¼ã‚¿
  let coinIdCounter = 0; // ã‚³ã‚¤ãƒ³IDã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆå‹•çš„ç”Ÿæˆç”¨ï¼‰
  let coinRespawnTimer = null; // ã‚³ã‚¤ãƒ³è£œå……ã‚¿ã‚¤ãƒãƒ¼
  
  // å„ä½œå“ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’ç®¡ç†
  const worksCoinGains = {}; // { workName: count }
  let profileCoinGains = 0; // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°
  
  // ãƒã‚¤ãƒ³ãƒˆå€å¢—æ©Ÿèƒ½
  let isPointBonusActive = false; // ãƒã‚¤ãƒ³ãƒˆå€å¢—ãŒæœ‰åŠ¹ã‹ã©ã†ã‹
  let bonusTimer = null; // ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒãƒ¼
  let bonusRemainingTime = 0; // æ®‹ã‚Šæ™‚é–“ï¼ˆç§’ï¼‰
  const BONUS_DURATION = 300; // ãƒœãƒ¼ãƒŠã‚¹æ™‚é–“ï¼ˆ5åˆ† = 300ç§’ï¼‰
  
  // FirebaseåˆæœŸåŒ–
  let db = null; // Firestoreã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
  let firebaseInitialized = false;
  
  // FirebaseåˆæœŸåŒ–é–¢æ•°
  async function initializeFirebase() {
    if (firebaseInitialized) return;
    
    try {
      // Firebase SDKã‚’å‹•çš„ã«èª­ã¿è¾¼ã‚€ï¼ˆv8ã®CDNãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼‰
      if (typeof firebase === 'undefined') {
        // CDNã‹ã‚‰Firebase SDKã‚’èª­ã¿è¾¼ã‚€
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js';
          script.onload = () => {
            const script2 = document.createElement('script');
            script2.src = 'https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js';
            script2.onload = resolve;
            script2.onerror = reject;
            document.head.appendChild(script2);
          };
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }
      
      // Firebaseè¨­å®š
      const firebaseConfig = {
        apiKey: "AIzaSyDpMOJJQwMooAMQKZgXKTsWpvYQHatqdZc",
        authDomain: "p-log-352de.firebaseapp.com",
        projectId: "p-log-352de",
        storageBucket: "p-log-352de.firebasestorage.app",
        messagingSenderId: "129028799360",
        appId: "1:129028799360:web:85110ed2f420a381471f65",
        measurementId: "G-DZS7QJZ0X7"
      };
      
      // FirebaseåˆæœŸåŒ–
      if (!firebase.apps || firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
      firebaseInitialized = true;
      
      // ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’èª­ã¿è¾¼ã‚€
      await loadCoinGains();
    } catch (error) {
      console.error('Firebase initialization error:', error);
    }
  }
  
  // Firestoreã‹ã‚‰ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’èª­ã¿è¾¼ã‚€
  async function loadCoinGains() {
    if (!db) return;
    
    try {
      // ä½œå“ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’èª­ã¿è¾¼ã‚€
      const worksDoc = await db.collection('coinGains').doc('works').get();
      if (worksDoc.exists) {
        const data = worksDoc.data();
        Object.keys(data).forEach(workName => {
          worksCoinGains[workName] = data[workName] || 0;
        });
        // å…¨ã¦ã®ä½œå“ã®è¡¨ç¤ºã‚’æ›´æ–°
        worksData.names.forEach(workName => {
          updateWorkCoinDisplay(workName);
        });
      }
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’èª­ã¿è¾¼ã‚€
      const profileDoc = await db.collection('coinGains').doc('profile').get();
      if (profileDoc.exists) {
        profileCoinGains = profileDoc.data().count || 0;
        updateProfileCoinDisplay();
      }
    } catch (error) {
      console.error('Error loading coin gains:', error);
    }
  }
  
  // Firestoreã«ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’ä¿å­˜ã™ã‚‹
  async function saveCoinGains(type, workName = null) {
    if (!db) {
      throw new Error('Firestore not initialized');
    }
    
    try {
      if (type === 'work' && workName) {
        // ä½œå“ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’æ›´æ–°ï¼ˆmerge: trueã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼‰
        await db.collection('coinGains').doc('works').set({
          [workName]: worksCoinGains[workName] || 0
        }, { merge: true });
      } else if (type === 'profile') {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’æ›´æ–°
        await db.collection('coinGains').doc('profile').set({
          count: profileCoinGains
        }, { merge: true });
      }
      return true; // æˆåŠŸã‚’è¿”ã™
    } catch (error) {
      console.error('Error saving coin gains:', error);
      throw error; // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
    }
  }
  
  // ã‚¿ãƒƒãƒæ“ä½œç”¨ã®å¤‰æ•°ï¼ˆä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯é¢¨ï¼‰
  let touchStartX = 0;
  let touchStartY = 0;
  let touchCurrentX = 0;
  let touchCurrentY = 0;
  let isTouching = false;
  let moveDirectionX = 0; // -1.0 ï½ 1.0: å·¦ã‹ã‚‰å³ã¸ã®é€£ç¶šå€¤ï¼ˆæ–œã‚æ–¹å‘ã‚‚å¯èƒ½ï¼‰
  let moveDirectionY = 0; // -1.0 ï½ 1.0: ä¸Šã‹ã‚‰ä¸‹ã¸ã®é€£ç¶šå€¤ï¼ˆæ–œã‚æ–¹å‘ã‚‚å¯èƒ½ï¼‰
  let inertiaVelocityX = 0; // æ…£æ€§é€Ÿåº¦X
  let inertiaVelocityY = 0; // æ…£æ€§é€Ÿåº¦Y
  let touchAnimationFrameId = null;
  const TOUCH_THRESHOLD = 20; // ã‚¿ãƒƒãƒé–‹å§‹ã¨ã¿ãªã™æœ€å°è·é›¢ï¼ˆpxã€å°‘ã—å¤§ããã—ã¦èª¤æ“ä½œã‚’é˜²ãï¼‰
  const MAX_TOUCH_DISTANCE = 80; // æœ€å¤§ã‚¿ãƒƒãƒè·é›¢ï¼ˆpxã€å°‘ã—å°ã•ãã—ã¦æ„Ÿåº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
  const INERTIA_DECAY = 0.92; // æ…£æ€§æ¸›è¡°ç‡ï¼ˆå°‘ã—å¼·ãã—ã¦æ—©ãæ­¢ã¾ã‚‹ã‚ˆã†ã«ï¼‰
  const MIN_INERTIA_VELOCITY = 0.01; // æ…£æ€§åœæ­¢ã®é–¾å€¤
  
  // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
  document.addEventListener('DOMContentLoaded', () => {
    cityView = document.getElementById('cityView');
    cityGrid = document.getElementById('cityGrid');
    person = document.getElementById('mainPerson');
    buildingModal = document.getElementById('buildingModal');
    modalTitle = document.getElementById('modalTitle');
    modalContent = document.getElementById('modalContent');
    
    // å»ºç‰©ã®é…ç½®å‡¦ç†
    setupBuildings();
    setupObjects();
    
    // å¹ãå‡ºã—ãƒã‚¤ãƒ³ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupPointBubbles();
    
    // ã‚³ã‚¤ãƒ³ã®é…ç½®
    setupCoins();
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupNavigationList();
    
    // åˆæœŸä½ç½®ã‚’è¨­å®š
    updatePosition();
    
    // ã‚³ã‚¤ãƒ³æ•°ã‚’åˆæœŸè¡¨ç¤º
    updateCoinCounter();
    
    // FirebaseåˆæœŸåŒ–ï¼ˆéåŒæœŸï¼‰
    initializeFirebase();
    
    // ã‚³ã‚¤ãƒ³å¿œæ´ãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    updateCoinGiveButton('work');
    updateCoinGiveButton('profile');
    
    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
    setupKeyboardControls();
    
    // ãƒœã‚¿ãƒ³æ“ä½œ
    setupButtonControls();
    
    // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
    setupTouchControls();
    
    // ä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupVirtualJoystick();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    setupModalEvents();
    
    // ã‚¿ã‚¦ãƒ³åˆ‡ã‚Šæ›¿ãˆã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    setupTownSwitching();
    
    // ä½ç½®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    setupResetPositionButton();
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    const profilePopup = document.getElementById('profilePopup');
    if (profilePopup) {
      const setupProfilePopupEvents = () => {
        const closeButton = profilePopup.querySelector('.popup-close-button');
        const closeBtn = profilePopup.querySelector('.popup-close-btn');
        const moreBtn = profilePopup.querySelector('.popup-more-btn');
        const coinGiveBtn = profilePopup.querySelector('.popup-coin-give-btn');
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        const closePopup = () => {
          profilePopup.classList.remove('active');
          
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚‚çµ‚äº†
          exitZoomMode();
          
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰isEventLockedã‚’è§£é™¤
          isEventLocked = false;
          
          setTimeout(() => {
            profilePopup.style.display = 'none';
          }, 300);
        };
        
        if (closeButton) {
          closeButton.addEventListener('click', closePopup);
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', closePopup);
        }
        
        if (moreBtn) {
          moreBtn.addEventListener('click', () => {
            // è©³ç´°ãƒšãƒ¼ã‚¸ã«é·ç§»ã™ã‚‹ãªã©ã®å‡¦ç†
          });
        }
        
        // ã‚³ã‚¤ãƒ³å¿œæ´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        if (coinGiveBtn) {
          coinGiveBtn.addEventListener('click', () => {
            supportWithCoin('profile');
          });
        }
        
        // ESCã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && profilePopup.classList.contains('active')) {
            closePopup();
          }
        });
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«é–‰ã˜ã‚‹
        document.addEventListener('click', function(e) {
          const profilePoint = document.querySelector('.profile-card .profile-point');
          if (profilePopup.classList.contains('active') && 
              !profilePopup.contains(e.target) && 
              e.target !== profilePoint) {
            closePopup();
          }
        });
      };
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
      setupProfilePopupEvents();
    }
  });
  
  // ãƒã‚¤ãƒ³ãƒˆã¨ã®è¡çªåˆ¤å®šé–¢é€£ã®ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
  
  // ã‚«ãƒ¡ãƒ©ã¨äººã®ä½ç½®ã®æ›´æ–°
  function updatePosition() {
    if (person) {
      // äººã®ä½ç½®ã‚’æ›´æ–°
      person.style.left = `${personX}%`;
      person.style.top = `${personY}%`;
      
      // ã‚ºãƒ¼ãƒ ä¸­ã§ãªã„å ´åˆã®ã¿ã‚«ãƒ¡ãƒ©ã¯äººã«è¿½å¾“
      if (!isZoomed) {
        // ä¸‰äººç§°è¦–ç‚¹ã®ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’è¨ˆç®—ï¼ˆäººã‚’ä¸­å¿ƒã«å°‘ã—å¾Œã‚ã‹ã‚‰æ–œã‚ä¸Šã‚’è¦‹ã‚‹ï¼‰
        cameraX = personX - 50;
        cameraY = personY - 50 + 15; // å°‘ã—ä¸‹ã‹ã‚‰è¦‹ä¸Šã’ã‚‹æ„Ÿã˜ã«
        
        // è¦–ç‚¹ã®æ›´æ–°ï¼ˆéƒ½å¸‚ã‚°ãƒªãƒƒãƒ‰ã‚’å‹•ã‹ã™ï¼‰
        if (cityGrid) {
          cityGrid.style.transform = `rotateX(55deg) scale(1.8) translate(${-cameraX}%, ${-cameraY}%)`;
        }
      }
      
      // ãƒã‚¤ãƒ³ãƒˆã¨ã®è¡çªåˆ¤å®š
      checkPointCollision();
      
      // ã‚³ã‚¤ãƒ³ã¨ã®è¡çªåˆ¤å®š
      checkCoinCollision();
    }
  }
  
  // ã‚³ã‚¤ãƒ³ã¨ã®è¡çªåˆ¤å®šé–¢æ•°
  function checkCoinCollision() {
    if (!person) return;
    
    const personRect = person.getBoundingClientRect();
    const coinElements = document.querySelectorAll('.coin');
    
    coinElements.forEach(coinEl => {
      // æ—¢ã«å–å¾—æ¸ˆã¿ã®ã‚³ã‚¤ãƒ³ã¯ç„¡è¦–
      if (coinEl.classList.contains('collected')) return;
      
      // ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„è¦ç´ ã¯ç„¡è¦–
      if (coinEl.offsetParent === null) return;
      
      const coinRect = coinEl.getBoundingClientRect();
      const overlap = !(personRect.right < coinRect.left || 
                        personRect.left > coinRect.right || 
                        personRect.bottom < coinRect.top || 
                        personRect.top > coinRect.bottom);
      
      if (overlap) {
        const coinId = coinEl.getAttribute('data-coin-id');
        if (coinId) {
          // ã‚³ã‚¤ãƒ³ã‚’å–å¾—
          collectCoin(coinId);
        }
      }
    });
  }
  
  // ã‚³ã‚¤ãƒ³ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  function collectCoin(coinId) {
    const coin = coins.find(c => c.id === coinId);
    if (!coin || coin.collected) return;
    
    coin.collected = true;
    
    // ãƒã‚¤ãƒ³ãƒˆå€å¢—ãŒæœ‰åŠ¹ãªå ´åˆã¯2å€ã«ã™ã‚‹
    const coinGain = isPointBonusActive ? 2 : 1;
    coinCount += coinGain;
    
    // ã‚³ã‚¤ãƒ³è¦ç´ ã‚’å–å¾—ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
    const coinElement = document.getElementById(coinId);
    if (coinElement) {
      // ãƒãƒªã‚ªé¢¨ã®å–å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
      coinElement.classList.add('collected');
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å®Œå…¨ã«éè¡¨ç¤ºï¼ˆ0.9ç§’å¾Œï¼‰
      setTimeout(() => {
        if (coinElement) {
          coinElement.style.display = 'none';
        }
      }, 900);
    }
    
    // ã€Œ+1ã€ã¾ãŸã¯ã€Œ+2ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    showCoinGainAnimation(coinGain);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºå¾Œã«ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦è¦–è¦šçš„ã«åˆ†ã‹ã‚Šã‚„ã™ãï¼‰
    setTimeout(() => {
      updateCoinCounter();
    }, 300);
    
    // ã‚³ã‚¤ãƒ³ã‚’å–å¾—ã—ãŸç›´å¾Œã«ã€ä¸è¶³ã—ã¦ã„ã‚‹åˆ†ã‚’å³åº§ã«è£œå……
    // DOMæ›´æ–°ã‚’å¾…ã¤ãŸã‚ã€å°‘ã—é…å»¶ã•ã›ã‚‹
    setTimeout(() => {
      respawnCoins();
    }, 600);
    
    // ã‚³ã‚¤ãƒ³è£œå……ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    if (coinRespawnTimer) {
      clearTimeout(coinRespawnTimer);
    }
    
    // ä¸€å®šæ™‚é–“å¾Œã«å†åº¦ã‚³ã‚¤ãƒ³ã‚’è£œå……ï¼ˆæœ€å¤§3ã¤ã«ãªã‚‹ã¾ã§ï¼‰
    coinRespawnTimer = setTimeout(() => {
      respawnCoins();
      coinRespawnTimer = null;
    }, COIN_RESPAWN_DELAY);
  }
  
  // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚’è§£é™¤ã™ã‚‹é–¢æ•°
  function exitZoomMode() {
    if (isZoomed) {
      isEventLocked = false; // Ensure unlock on exit
      isZoomed = false;
      zoomedPointName = null;
      
      // ã‚«ãƒ¡ãƒ©ã‚’äººã®ä½ç½®ã«æˆ»ã™
      cameraX = personX - 50;
      cameraY = personY - 50 + 15;
      
      if (cityGrid) {
        cityGrid.style.transition = 'transform 0.5s ease-out';
        cityGrid.style.transform = `rotateX(55deg) scale(1.8) translate(${-cameraX}%, ${-cameraY}%)`;
        
        // ã‚ºãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        document.body.classList.remove('is-zoomed');
      }
      
      // ã™ã¹ã¦ã®work-titleã‚’éè¡¨ç¤º
      document.querySelectorAll('.work-title').forEach(title => {
        title.style.opacity = '0';
        title.style.transform = 'translateX(-50%)';
      });
      
      // ãƒ¯ãƒ¼ã‚¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      const workPopup = document.getElementById('workPopup');
      if (workPopup && workPopup.classList.contains('active')) {
        workPopup.classList.remove('active');
        setTimeout(() => {
          workPopup.style.display = 'none';
        }, 300);
      }
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚‚é–‰ã˜ã‚‹
      const profilePopup = document.getElementById('profilePopup');
      if (profilePopup && profilePopup.classList.contains('active')) {
        profilePopup.classList.remove('active');
        setTimeout(() => {
          profilePopup.style.display = 'none';
        }, 300);
      }
      
      // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚‚é–‰ã˜ã‚‹
      const adPopup = document.getElementById('adPopup');
      if (adPopup && adPopup.classList.contains('active')) {
        adPopup.classList.remove('active');
        setTimeout(() => {
          adPopup.style.display = 'none';
        }, 300);
      }
    }
  }
  
  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupKeyboardControls() {
    document.addEventListener('keydown', (e) => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
      if (isEventLocked) {
        return;
      }
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
      if (isZoomed) {
        exitZoomMode();
        return;
      }
      
      isMoving = true;
      const oldX = personX;
      const oldY = personY;
      
      switch (e.key.toLowerCase()) {
        case 'w':
          personY = Math.max(10, personY - speed);
          break;
        case 'a':
          personX = Math.max(10, personX - speed);
          break;
        case 's':
          personY = Math.min(90, personY + speed);
          break;
        case 'd':
          personX = Math.min(90, personX + speed);
          break;
      }
      
      // ä½ç½®ãŒå¤‰ã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
      if (oldX !== personX || oldY !== personY) {
        updatePosition();
      }
    });
    
    document.addEventListener('keyup', function() {
      isMoving = false;
    });
  }
  
  // ãƒœã‚¿ãƒ³æ“ä½œã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupButtonControls() {
    document.getElementById('w-btn')?.addEventListener('mousedown', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
      if (isEventLocked) {
        return;
      }
      // ãƒœã‚¿ãƒ³æ“ä½œãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
      if (isZoomed) {
        exitZoomMode();
        return;
      }
      
      isMoving = true;
      personY = Math.max(10, personY - speed);
      updatePosition();
    });
    
    document.getElementById('a-btn')?.addEventListener('mousedown', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
      if (isEventLocked) {
        return;
      }
      // ãƒœã‚¿ãƒ³æ“ä½œãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
      if (isZoomed) {
        exitZoomMode();
        return;
      }
      
      isMoving = true;
      personX = Math.max(10, personX - speed);
      updatePosition();
    });
    
    document.getElementById('s-btn')?.addEventListener('mousedown', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
      if (isEventLocked) {
        return;
      }
      // ãƒœã‚¿ãƒ³æ“ä½œãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
      if (isZoomed) {
        exitZoomMode();
        return;
      }
      
      isMoving = true;
      personY = Math.min(90, personY + speed);
      updatePosition();
    });
    
    document.getElementById('d-btn')?.addEventListener('mousedown', () => {
      // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
      if (isEventLocked) {
        return;
      }
      // ãƒœã‚¿ãƒ³æ“ä½œãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
      if (isZoomed) {
        exitZoomMode();
        return;
      }
      
      isMoving = true;
      personX = Math.min(90, personX + speed);
      updatePosition();
    });
    
    // ãƒœã‚¿ãƒ³ã‹ã‚‰æŒ‡ãŒé›¢ã‚ŒãŸã¨ãã®å‡¦ç†
    document.querySelectorAll('.controls button').forEach(button => {
      button.addEventListener('mouseup', () => {
        isMoving = false;
      });
      button.addEventListener('mouseleave', () => {
        isMoving = false;
      });
    });
  }
  
  // ç¶™ç¶šç§»å‹•ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
  function updateContinuousMovement() {
    if (touchAnimationFrameId) {
      cancelAnimationFrame(touchAnimationFrameId);
    }
    
    const animate = () => {
      let shouldContinue = false;
      
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç§»å‹•ã‚’åœæ­¢
      const workPopup = document.getElementById('workPopup');
      const profilePopup = document.getElementById('profilePopup');
      const adPopup = document.getElementById('adPopup');
      const isPopupOpen = (workPopup && workPopup.classList.contains('active')) ||
                         (profilePopup && profilePopup.classList.contains('active')) ||
                         (adPopup && adPopup.classList.contains('active'));
      
      if (isPopupOpen || isEventLocked) {
        moveDirectionX = 0;
        moveDirectionY = 0;
        inertiaVelocityX = 0;
        inertiaVelocityY = 0;
        isMoving = false;
        if (touchAnimationFrameId) {
          cancelAnimationFrame(touchAnimationFrameId);
          touchAnimationFrameId = null;
        }
        // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ä¸­å¤®ã«æˆ»ã™ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ã¿ï¼‰
        const isMobile = window.innerWidth <= 768;
        if (isMobile && window.updateJoystickFromDirection) {
          window.updateJoystickFromDirection(0, 0);
        }
        return;
      }
      
      // ã‚¿ãƒƒãƒä¸­ã®ç¶™ç¶šç§»å‹•ï¼ˆã‚¿ãƒƒãƒæ“ä½œæ™‚ã¯ã‚ˆã‚Šé…ã„é€Ÿåº¦ã‚’ä½¿ç”¨ï¼‰
      if (isTouching && (moveDirectionX !== 0 || moveDirectionY !== 0)) {
        const oldX = personX;
        const oldY = personY;
        
        // ç¸¦æ–¹å‘ï¼ˆç‰¹ã«ä¸Šæ–¹å‘ï¼‰ã¯ã•ã‚‰ã«é…ã
        const currentSpeedY = moveDirectionY < 0 ? touchSpeedVertical : touchSpeed;
        const currentSpeedX = touchSpeed;
        
        personX = Math.max(10, Math.min(90, personX + moveDirectionX * currentSpeedX));
        personY = Math.max(10, Math.min(90, personY + moveDirectionY * currentSpeedY));
        
        // ç§»å‹•æ–¹å‘ã«åŸºã¥ã„ã¦ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’æ›´æ–°ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ã¿ï¼‰
        // äººã®ç§»å‹•æ–¹å‘ã«åˆã‚ã›ã¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’é…ç½®
        const isMobile = window.innerWidth <= 768;
        if (isMobile && window.updateJoystickFromDirection) {
          window.updateJoystickFromDirection(moveDirectionX, moveDirectionY);
        }
        
        if (oldX !== personX || oldY !== personY) {
          updatePosition();
          shouldContinue = true;
        }
      }
      // æ…£æ€§ç§»å‹•ï¼ˆã‚¿ãƒƒãƒã‚’é›¢ã—ãŸå¾Œï¼‰
      else if (!isTouching && (Math.abs(inertiaVelocityX) > MIN_INERTIA_VELOCITY || Math.abs(inertiaVelocityY) > MIN_INERTIA_VELOCITY)) {
        const oldX = personX;
        const oldY = personY;
        
        // ç¸¦æ–¹å‘ï¼ˆç‰¹ã«ä¸Šæ–¹å‘ï¼‰ã¯ã•ã‚‰ã«é…ã
        const currentSpeedY = inertiaVelocityY < 0 ? touchSpeedVertical : touchSpeed;
        const currentSpeedX = touchSpeed;
        
        personX = Math.max(10, Math.min(90, personX + inertiaVelocityX * currentSpeedX));
        personY = Math.max(10, Math.min(90, personY + inertiaVelocityY * currentSpeedY));
        
        // æ…£æ€§æ¸›è¡°
        inertiaVelocityX *= INERTIA_DECAY;
        inertiaVelocityY *= INERTIA_DECAY;
        
        // æ…£æ€§ç§»å‹•ä¸­ã¯ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ä¸­å¤®ã«æˆ»ã™ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ã¿ï¼‰
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          const joystickStick = document.getElementById('joystickStick');
          if (joystickStick) {
            // æ…£æ€§é€Ÿåº¦ãŒé–¾å€¤ä»¥ä¸‹ã«ãªã£ãŸã‚‰ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ä¸­å¤®ã«æˆ»ã™
            if (Math.abs(inertiaVelocityX) <= MIN_INERTIA_VELOCITY && Math.abs(inertiaVelocityY) <= MIN_INERTIA_VELOCITY) {
              joystickStick.style.transform = 'translate(-50%, -50%)';
              joystickStick.classList.remove('active');
            }
          }
        }
        
        if (oldX !== personX || oldY !== personY) {
          updatePosition();
          shouldContinue = true;
        }
      }
      
      if (shouldContinue) {
        touchAnimationFrameId = requestAnimationFrame(animate);
      } else {
        touchAnimationFrameId = null;
        isMoving = false;
      }
    };
    
    animate();
  }
  
  // ã‚¿ãƒƒãƒæ“ä½œã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆç”»é¢å…¨ä½“ã§ã®ã‚¿ãƒƒãƒæ“ä½œ - PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
  function setupTouchControls() {
    if (cityView) {
      // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã§ã‚‚ç”»é¢å…¨ä½“ã®ã‚¿ãƒƒãƒæ“ä½œã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã¨ä½µç”¨å¯èƒ½ï¼‰
      
      cityView.addEventListener('touchstart', function(e) {
        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
        if (isEventLocked) {
          return;
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹åŒ–
        const workPopup = document.getElementById('workPopup');
        const profilePopup = document.getElementById('profilePopup');
        const adPopup = document.getElementById('adPopup');
        const isPopupOpen = (workPopup && workPopup.classList.contains('active')) ||
                           (profilePopup && profilePopup.classList.contains('active')) ||
                           (adPopup && adPopup.classList.contains('active'));
        if (isPopupOpen) {
          return;
        }
        
        // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®é ˜åŸŸã‚’é™¤å¤–
        const joystickBase = document.getElementById('joystickBase');
        if (joystickBase) {
          const joystickRect = joystickBase.getBoundingClientRect();
          const touch = e.touches[0];
          if (touch.clientX >= joystickRect.left && touch.clientX <= joystickRect.right &&
              touch.clientY >= joystickRect.top && touch.clientY <= joystickRect.bottom) {
            return; // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®é ˜åŸŸå†…ã®ã‚¿ãƒƒãƒã¯ç„¡è¦–
          }
        }
        
        // ã‚¿ãƒƒãƒæ“ä½œãŒã‚ã‚Œã°ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        if (isZoomed) {
          exitZoomMode();
          return;
        }
        
        // æ…£æ€§ç§»å‹•ã‚’åœæ­¢
        inertiaVelocityX = 0;
        inertiaVelocityY = 0;
        
        isTouching = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        touchCurrentX = touchStartX;
        touchCurrentY = touchStartY;
        moveDirectionX = 0;
        moveDirectionY = 0;
      });
      
      cityView.addEventListener('touchmove', function(e) {
        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç›´å¾Œã¯æ“ä½œã‚’ãƒ­ãƒƒã‚¯
        if (isEventLocked) {
          return;
        }
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹åŒ–
        const workPopup = document.getElementById('workPopup');
        const profilePopup = document.getElementById('profilePopup');
        const adPopup = document.getElementById('adPopup');
        const isPopupOpen = (workPopup && workPopup.classList.contains('active')) ||
                           (profilePopup && profilePopup.classList.contains('active')) ||
                           (adPopup && adPopup.classList.contains('active'));
        if (isPopupOpen) {
          return;
        }
        
        // ã‚ºãƒ¼ãƒ ä¸­ã¯ã‚¿ãƒƒãƒæ“ä½œã‚’ç„¡è¦–
        if (isZoomed) return;
        
        if (!isTouching) return;
        
        e.preventDefault();
        touchCurrentX = e.touches[0].clientX;
        touchCurrentY = e.touches[0].clientY;
        
        // ç”»é¢å…¨ä½“ã®ã‚¿ãƒƒãƒæ“ä½œã§ã‚‚ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’å‹•ã‹ã™ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ã¿ï¼‰
        const isMobile = window.innerWidth <= 768;
        if (isMobile && window.updateJoystickPosition) {
          window.updateJoystickPosition(touchCurrentX, touchCurrentY);
        }
        
        const diffX = touchCurrentX - touchStartX;
        const diffY = touchCurrentY - touchStartY;
        const distance = Math.sqrt(diffX * diffX + diffY * diffY);
        
        // é–¾å€¤ä»¥ä¸‹ã®å ´åˆã¯åœæ­¢
        if (distance < TOUCH_THRESHOLD) {
          moveDirectionX = 0;
          moveDirectionY = 0;
          isMoving = false;
          if (touchAnimationFrameId) {
            cancelAnimationFrame(touchAnimationFrameId);
            touchAnimationFrameId = null;
          }
          // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚‚ãƒªã‚»ãƒƒãƒˆ
          if (isMobile && window.resetJoystick) {
            window.resetJoystick();
          }
          return;
        }
        
        // æ­£è¦åŒ–ã•ã‚ŒãŸæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’è¨ˆç®—ï¼ˆæœ€å¤§è·é›¢ã§ã‚¯ãƒ©ãƒ³ãƒ—ï¼‰
        const normalizedDistance = Math.min(distance, MAX_TOUCH_DISTANCE);
        const normalizedDiffX = (diffX / distance) * (normalizedDistance / MAX_TOUCH_DISTANCE);
        const normalizedDiffY = (diffY / distance) * (normalizedDistance / MAX_TOUCH_DISTANCE);
        
        // ç§»å‹•æ–¹å‘ã‚’æ±ºå®šï¼ˆé€£ç¶šå€¤ã§æ–œã‚æ–¹å‘ã‚‚å¯èƒ½ï¼‰
        // æ­£è¦åŒ–ã•ã‚ŒãŸæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆ-1.0 ï½ 1.0ã®é€£ç¶šå€¤ï¼‰
        moveDirectionX = normalizedDiffX;
        moveDirectionY = normalizedDiffY;
        
        // ç§»å‹•æ–¹å‘ã«åŸºã¥ã„ã¦ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’æ›´æ–°ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã®ã¿ï¼‰
        // äººã®ç§»å‹•æ–¹å‘ã«åˆã‚ã›ã¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’é…ç½®
        if (isMobile && window.updateJoystickFromDirection) {
          window.updateJoystickFromDirection(moveDirectionX, moveDirectionY);
        }
        
        // ç¶™ç¶šç§»å‹•ã‚’é–‹å§‹
        if (!touchAnimationFrameId) {
          isMoving = true;
          updateContinuousMovement();
        }
      });
      
      cityView.addEventListener('touchend', function(e) {
        if (!isTouching) return;
        
        isTouching = false;
        
        // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã§ã¯ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
        const isMobile = window.innerWidth <= 768;
        if (isMobile && window.resetJoystick) {
          window.resetJoystick();
        }
        
        // æœ€å¾Œã®ç§»å‹•æ–¹å‘ã‚’æ…£æ€§é€Ÿåº¦ã¨ã—ã¦ä¿å­˜
        if (moveDirectionX !== 0 || moveDirectionY !== 0) {
          inertiaVelocityX = moveDirectionX;
          inertiaVelocityY = moveDirectionY;
          
          // ç¶™ç¶šç§»å‹•ã‚’ç¶™ç¶šï¼ˆæ…£æ€§ç§»å‹•ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
          if (!touchAnimationFrameId) {
            updateContinuousMovement();
            }
          } else {
          // åœæ­¢ã—ã¦ã„ãŸå ´åˆã¯å®Œå…¨ã«åœæ­¢
          isMoving = false;
          if (touchAnimationFrameId) {
            cancelAnimationFrame(touchAnimationFrameId);
            touchAnimationFrameId = null;
          }
        }
        
        moveDirectionX = 0;
        moveDirectionY = 0;
      });
      
      cityView.addEventListener('touchcancel', function(e) {
        // ã‚¿ãƒƒãƒãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã‚‚åŒæ§˜ã«å‡¦ç†
        isTouching = false;
        moveDirectionX = 0;
        moveDirectionY = 0;
        inertiaVelocityX = 0;
        inertiaVelocityY = 0;
        isMoving = false;
        if (touchAnimationFrameId) {
          cancelAnimationFrame(touchAnimationFrameId);
          touchAnimationFrameId = null;
        }
        // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã§ã¯ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚‚ãƒªã‚»ãƒƒãƒˆ
        const isMobile = window.innerWidth <= 768;
        if (isMobile && window.resetJoystick) {
          window.resetJoystick();
        }
      });
    }
  }
  
  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function isPopupOpen() {
    const workPopup = document.getElementById('workPopup');
    const profilePopup = document.getElementById('profilePopup');
    const adPopup = document.getElementById('adPopup');
    const blogPopup = document.getElementById('blogPopup');
    return (workPopup && workPopup.classList.contains('active')) ||
           (profilePopup && profilePopup.classList.contains('active')) ||
           (adPopup && adPopup.classList.contains('active')) ||
           (blogPopup && blogPopup.classList.contains('active'));
  }
  
  // ä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
  function setupVirtualJoystick() {
    const joystickBase = document.getElementById('joystickBase');
    const joystickStick = document.getElementById('joystickStick');
    if (!joystickBase || !joystickStick) return;
    
    let joystickActive = false;
    let joystickBaseRect = null;
    // ãƒ¢ãƒã‚¤ãƒ«ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®åŠå¾„ã‚’èª¿æ•´
    const isMobile = window.innerWidth <= 768;
    const JOYSTICK_RADIUS = isMobile ? 22 : 28; // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ãƒ™ãƒ¼ã‚¹åŠå¾„ï¼ˆpxã€ã‚µã‚¤ã‚ºã‚’å°ã•ãèª¿æ•´ï¼‰
    
    // ç§»å‹•æ–¹å‘ã«åŸºã¥ã„ã¦ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ãƒ†ã‚£ãƒƒã‚¯ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    window.updateJoystickFromDirection = (dirX, dirY) => {
      if (!joystickBase || !joystickStick) return;
      
      // ç§»å‹•æ–¹å‘ãŒ0ã®å ´åˆã¯ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ä¸­å¤®ã«æˆ»ã™
      if (dirX === 0 && dirY === 0) {
        joystickStick.style.transform = 'translate(-50%, -50%)';
        joystickStick.classList.remove('active');
        return;
      }
      
      // ç§»å‹•æ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’æ­£è¦åŒ–
      const length = Math.sqrt(dirX * dirX + dirY * dirY);
      const normalizedX = dirX / length;
      const normalizedY = dirY / length;
      
      // ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ç§»å‹•æ–¹å‘ã«åˆã‚ã›ã¦é…ç½®ï¼ˆæœ€å¤§åŠå¾„ã¾ã§ï¼‰
      const stickX = normalizedX * JOYSTICK_RADIUS;
      const stickY = normalizedY * JOYSTICK_RADIUS;
      
      // ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ä½ç½®ã‚’æ›´æ–°
      joystickStick.style.transform = `translate(calc(-50% + ${stickX}px), calc(-50% + ${stickY}px))`;
      joystickStick.classList.add('active');
    };
    
    // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆæŒ‡ã®ä½ç½®ã‹ã‚‰ç§»å‹•æ–¹å‘ã‚’è¨ˆç®—ã—ã¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’æ›´æ–°ï¼‰
    window.updateJoystickPosition = (clientX, clientY) => {
      if (!joystickBase || !joystickStick) return;
      
      // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã®ä½ç½®ã‚’å–å¾—ï¼ˆæ¯å›å–å¾—ã—ã¦æœ€æ–°ã®ä½ç½®ã‚’åæ˜ ï¼‰
      const baseRect = joystickBase.getBoundingClientRect();
      const baseCenterX = baseRect.left + baseRect.width / 2;
      const baseCenterY = baseRect.top + baseRect.height / 2;
      
      const diffX = clientX - baseCenterX;
      const diffY = clientY - baseCenterY;
      const distance = Math.sqrt(diffX * diffX + diffY * diffY);
      const maxDistance = JOYSTICK_RADIUS;
      
      // ãƒ™ãƒ¼ã‚¹ã®ç¯„å›²å†…ã«åˆ¶é™
      const clampedDistance = Math.min(distance, maxDistance);
      
      // é–¾å€¤ä»¥ä¸‹ã®å ´åˆã¯åœæ­¢
      if (clampedDistance < TOUCH_THRESHOLD) {
        moveDirectionX = 0;
        moveDirectionY = 0;
        isMoving = false;
        if (touchAnimationFrameId) {
          cancelAnimationFrame(touchAnimationFrameId);
          touchAnimationFrameId = null;
        }
        // ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’ä¸­å¤®ã«æˆ»ã™
        joystickStick.style.transform = 'translate(-50%, -50%)';
        joystickStick.classList.remove('active');
        return;
      }
      
      // ç§»å‹•æ–¹å‘ã‚’è¨ˆç®—ï¼ˆæ­£è¦åŒ–ï¼‰
      const normalizedX = clampedDistance > 0 ? diffX / distance : 0;
      const normalizedY = clampedDistance > 0 ? diffY / distance : 0;
      
      // ç§»å‹•æ–¹å‘ã‚’æ±ºå®šï¼ˆé€£ç¶šå€¤ã§æ–œã‚æ–¹å‘ã‚‚å¯èƒ½ï¼‰
      // æ­£è¦åŒ–ã•ã‚ŒãŸæ–¹å‘ãƒ™ã‚¯ãƒˆãƒ«ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆ-1.0 ï½ 1.0ã®é€£ç¶šå€¤ï¼‰
      moveDirectionX = normalizedX;
      moveDirectionY = normalizedY;
      
      // ç§»å‹•æ–¹å‘ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’é…ç½®ï¼ˆäººã®ç§»å‹•æ–¹å‘ã«åˆã‚ã›ã‚‹ï¼‰
      if (window.updateJoystickFromDirection) {
        window.updateJoystickFromDirection(moveDirectionX, moveDirectionY);
      }
      
      // ç¶™ç¶šç§»å‹•ã‚’é–‹å§‹
      if (!touchAnimationFrameId) {
        isMoving = true;
        updateContinuousMovement();
      }
    };
    
    const resetJoystick = () => {
      if (joystickStick) {
        joystickStick.style.transform = 'translate(-50%, -50%)';
        joystickStick.classList.remove('active');
      }
      moveDirectionX = 0;
      moveDirectionY = 0;
    };
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒªã‚»ãƒƒãƒˆé–¢æ•°ã‚‚å…¬é–‹
    window.resetJoystick = resetJoystick;
    
    // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã§ã®ã‚¿ãƒƒãƒé–‹å§‹
    joystickBase.addEventListener('touchstart', function(e) {
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ç„¡åŠ¹åŒ–
      if (isEventLocked || isZoomed || isPopupOpen()) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      joystickActive = true;
      joystickBaseRect = joystickBase.getBoundingClientRect();
      const touch = e.touches[0];
      
      // æ…£æ€§ç§»å‹•ã‚’åœæ­¢
      inertiaVelocityX = 0;
      inertiaVelocityY = 0;
      isTouching = true;
      
      if (window.updateJoystickPosition) {
        window.updateJoystickPosition(touch.clientX, touch.clientY);
      }
    });
    
    // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã§ã®ã‚¿ãƒƒãƒç§»å‹•
    joystickBase.addEventListener('touchmove', function(e) {
      if (!joystickActive || isEventLocked || isZoomed || isPopupOpen()) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      const touch = e.touches[0];
      if (window.updateJoystickPosition) {
        window.updateJoystickPosition(touch.clientX, touch.clientY);
      }
    });
    
    // ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãƒ™ãƒ¼ã‚¹ã§ã®ã‚¿ãƒƒãƒçµ‚äº†
    joystickBase.addEventListener('touchend', function(e) {
      if (!joystickActive) return;
      
      e.preventDefault();
      e.stopPropagation();
      
      joystickActive = false;
      isTouching = false;
      resetJoystick();
      
      // æœ€å¾Œã®ç§»å‹•æ–¹å‘ã‚’æ…£æ€§é€Ÿåº¦ã¨ã—ã¦ä¿å­˜
      if (moveDirectionX !== 0 || moveDirectionY !== 0) {
        inertiaVelocityX = moveDirectionX;
        inertiaVelocityY = moveDirectionY;
        
        // ç¶™ç¶šç§»å‹•ã‚’ç¶™ç¶šï¼ˆæ…£æ€§ç§»å‹•ã«åˆ‡ã‚Šæ›¿ãˆï¼‰
        if (!touchAnimationFrameId) {
          updateContinuousMovement();
        }
      } else {
        // åœæ­¢ã—ã¦ã„ãŸå ´åˆã¯å®Œå…¨ã«åœæ­¢
        isMoving = false;
        if (touchAnimationFrameId) {
          cancelAnimationFrame(touchAnimationFrameId);
          touchAnimationFrameId = null;
        }
      }
    });
    
    joystickBase.addEventListener('touchcancel', function(e) {
      if (!joystickActive) return;
      
      joystickActive = false;
      isTouching = false;
      resetJoystick();
      moveDirectionX = 0;
      moveDirectionY = 0;
      inertiaVelocityX = 0;
      inertiaVelocityY = 0;
      isMoving = false;
      if (touchAnimationFrameId) {
        cancelAnimationFrame(touchAnimationFrameId);
        touchAnimationFrameId = null;
      }
    });
  }
  
  // æ­©è¡Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
  function animateWalk() {
    if (isMoving) {
      walkCycle = (walkCycle + 1) % 20;
      const leftLeg = document.querySelector('.person-leg.left');
      const rightLeg = document.querySelector('.person-leg.right');
      const leftArm = document.querySelector('.person-arm.left');
      const rightArm = document.querySelector('.person-arm.right');
      
      if (leftLeg && rightLeg && leftArm && rightArm) {
        // è„šã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        if (walkCycle < 10) {
          leftLeg.style.transform = 'rotate(-15deg)';
          rightLeg.style.transform = 'rotate(15deg)';
          leftArm.style.transform = 'rotate(15deg)';
          rightArm.style.transform = 'rotate(-15deg)';
        } else {
          leftLeg.style.transform = 'rotate(15deg)';
          rightLeg.style.transform = 'rotate(-15deg)';
          leftArm.style.transform = 'rotate(-15deg)';
          rightArm.style.transform = 'rotate(15deg)';
        }
      }
    } else {
      // æ­¢ã¾ã£ã¦ã„ã‚‹ã¨ãã¯ç›´ç«‹
      const leftLeg = document.querySelector('.person-leg.left');
      const rightLeg = document.querySelector('.person-leg.right');
      const leftArm = document.querySelector('.person-arm.left');
      const rightArm = document.querySelector('.person-arm.right');
      
      if (leftLeg && rightLeg && leftArm && rightArm) {
        leftLeg.style.transform = 'rotate(0)';
        rightLeg.style.transform = 'rotate(0)';
        leftArm.style.transform = 'rotate(0)';
        rightArm.style.transform = 'rotate(0)';
      }
    }
  }
  
  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
  setInterval(animateWalk, 100);
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
  function setupModalEvents() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    const closeButton = document.querySelector('.close-button');
    closeButton?.addEventListener('click', () => {
      closeModal();
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    window.addEventListener('click', (e) => {
      const modal = document.getElementById('buildingModal');
      const backdrop = document.querySelector('.modal-backdrop');
      if (modal && (e.target === modal || e.target === backdrop)) {
        closeModal();
      }
    });
    
    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
  function closeModal() {
    const modal = document.getElementById('buildingModal');
    if (modal) {
      modal.classList.remove('active');
      
      // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚‚è§£é™¤
      if (isZoomed) {
        exitZoomMode();
      }
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«éè¡¨ç¤º
      setTimeout(() => {
        if (modal) {
          modal.style.display = 'none';
        }
      }, 300);
    }
  }
  
  // å»ºç‰©æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showBuildingInfo(buildingId) {
    const building = buildingData.find(b => b.id === buildingId);
    const modal = document.getElementById('buildingModal');
    
    if (building && modalTitle && modalContent && modal) {
      modalTitle.textContent = building.name;
      
      // å»ºç‰©ã®è©³ç´°æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
      modalContent.innerHTML = `
        <div class="building-type">${getBuildingTypeText(building.type)}</div>
        <p class="building-description">${building.description}</p>
      `;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«activeè¿½åŠ ï¼‰
      modal.style.display = 'flex';
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒˆãƒ©ãƒƒãƒ—ã®ãŸã‚ã«å¿…è¦
      setTimeout(() => {
        modal?.classList.add('active');
      }, 10);
    } else {
      console.error('å»ºç‰©æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', buildingId);
    }
  }
  
  // å»ºç‰©ã‚¿ã‚¤ãƒ—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
  function getBuildingTypeText(type) {
    switch (type) {
      case 'megastructure':
        return 'è¶…é«˜å±¤è¤‡åˆãƒ“ãƒ«';
      case 'tall':
        return 'é«˜å±¤ãƒ“ãƒ«';
      case 'standard':
        return 'æ¨™æº–ãƒ“ãƒ«';
      case 'small':
        return 'å°å‹å»ºç¯‰';
      case 'ruins':
        return 'å»ƒå¢Ÿ';
      default:
        return 'å»ºç¯‰ç‰©';
    }
  }

  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆPCç”¨ã®company-itemã¨ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®mobile-portfolio-buttonã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
  function setupNavigationList() {
    // PCç”¨ã®company-item
    const navItems = document.querySelectorAll('.company-item');
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®mobile-portfolio-buttonï¼ˆbuttonè¦ç´ ï¼‰
    const mobileNavItems = document.querySelectorAll('.mobile-portfolio-button');
    
    // å…±é€šã®ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    const handleItemClick = (item) => {
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é …ç›®ã®å‡¦ç†
      if (item.hasAttribute('data-profile-point')) {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã®ã¿ï¼‰
          if (item.classList.contains('mobile-portfolio-button')) {
            const menuDropdown = document.getElementById('mobileMenuDropdown');
            const menuBtn = document.getElementById('mobileMenuBtn');
            const header = document.querySelector('.portfolio-header');
            if (menuDropdown && menuBtn && header) {
              menuDropdown.classList.remove('active');
              menuBtn.classList.remove('active');
              header.classList.remove('menu-open');
            }
          }
          zoomToPoint('profile');
          setTimeout(() => {
            showProfilePopup();
          }, 600);
        });
        return;
      }
      
      // ä½œå“é …ç›®ã®å‡¦ç†
      const workName = item.getAttribute('data-work-name');
      if (workName) {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          // ãƒ¢ãƒã‚¤ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚¢ã‚¤ãƒ†ãƒ ã®å ´åˆã®ã¿ï¼‰
          if (item.classList.contains('mobile-portfolio-button')) {
            const menuDropdown = document.getElementById('mobileMenuDropdown');
            const menuBtn = document.getElementById('mobileMenuBtn');
            const header = document.querySelector('.portfolio-header');
            if (menuDropdown && menuBtn && header) {
              menuDropdown.classList.remove('active');
              menuBtn.classList.remove('active');
              header.classList.remove('menu-open');
            }
          }
          zoomToPoint(workName);
          setTimeout(() => {
            showWorkPopup(workName);
          }, 600);
        });
      }
    };
    
    // PCç”¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    navItems.forEach(item => handleItemClick(item));
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    mobileNavItems.forEach(item => handleItemClick(item));
  }

  // ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®å‡¦ç†ã‚’è¿½åŠ ï¼ˆçµ±åˆç‰ˆï¼‰
  function setupPointBubbles() {
    const points = document.querySelectorAll('.point-bubble');
    const activeTownElement = document.querySelector('.town-list li.active a');
    const currentTown = activeTownElement?.textContent?.trim().toLowerCase() || 'works';
    
    points.forEach((point, index) => {
      // ãƒã‚¤ãƒ³ãƒˆã«IDã‚’è¨­å®š
      point.setAttribute('id', `point-${index + 1}`);
      point.classList.add('interactive');
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã®ç‰¹åˆ¥å‡¦ç†ï¼ˆworksã‚¿ã‚¦ãƒ³ã§ã‚‚æœ‰åŠ¹ï¼‰
      if (point.hasAttribute('data-profile-point')) {
        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’è¨­å®š
        const profilePos = pointOffsetMap['works']?.['profile'] || profileData.position;
        if (profilePos) {
          point.style.left = `${profilePos.x}%`;
          point.style.top = `${profilePos.y}%`;
        }
        point.addEventListener('click', (e) => {
          e.stopPropagation();
          const profilePopup = document.getElementById('profilePopup');
          if (profilePopup?.classList.contains('active')) {
            hideProfilePopup();
          } else {
            // ã‚ºãƒ¼ãƒ ã—ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            zoomToPoint('profile');
            setTimeout(() => {
            showProfilePopup();
            }, 600);
          }
        });
        return; // ã“ã®å¾Œã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      }
      
      // åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®ç‰¹åˆ¥å‡¦ç†
      if (point.hasAttribute('data-ad-point')) {
        // åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’è¨­å®š
        const adPos = pointOffsetMap['works']?.['ad'] || { x: 40, y: 90 };
        if (adPos) {
          point.style.left = `${adPos.x}%`;
          point.style.top = `${adPos.y}%`;
        }
        
        point.addEventListener('click', (e) => {
          e.stopPropagation();
          const adPopup = document.getElementById('adPopup');
          if (adPopup?.classList.contains('active')) {
            hideAdPopup();
          } else {
            // ã‚ºãƒ¼ãƒ ã—ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            zoomToPoint('ad');
            setTimeout(() => {
              showAdPopup();
            }, 600);
          }
        });
        return; // ã“ã®å¾Œã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      }
      
      // Works townã®å ´åˆã¯ä½œå“æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆçµ±åˆå¾Œã¯åŸºæœ¬çš„ã«worksï¼‰
      if (currentTown.includes('works') || !currentTown.includes('blogs')) {
        const workName = point.getAttribute('data-work-name') || '';
        if (workName) {
          // ä½œå“ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’å‹•çš„ã«è¨­å®š
          const workPos = worksData.positions[workName];
          if (workPos) {
            point.style.left = `${workPos.x}%`;
            point.style.top = `${workPos.y}%`;
          }
        
        point.addEventListener('click', (e) => {
          e.stopPropagation();
          // ã¾ãšã‚ºãƒ¼ãƒ ã—ã¦ã€ãã®å¾Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
          zoomToPoint(workName);
          setTimeout(() => {
            showWorkPopup(workName);
          }, 600);
        });
      }
      }
      // Blogs townã®å ´åˆã¯ãƒ–ãƒ­ã‚°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
      else if (currentTown.includes('blogs')) {
        const blogName = point.getAttribute('data-blog-name') || '';
        if (blogName) {
          point.addEventListener('click', (e) => {
            e.stopPropagation();
            zoomToPoint(blogName);
            setTimeout(() => {
              showBlogPopup(blogName);
            }, 600);
          });
        }
      } else {
        // ãã‚Œä»¥å¤–ã®ã‚¿ã‚¦ãƒ³ã§ã¯å»ºç‰©æƒ…å ±ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        point.addEventListener('click', (e) => {
          e.stopPropagation();
          showBuildingInfo(`building-${index + 1}`);
        });
      }
    });
  }

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºé–¢æ•°ï¼ˆçµ±åˆç‰ˆ - ä½œå“ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨åŒã˜ä»•æ§˜ï¼‰
  function showProfilePopup() {
    const profilePopup = document.getElementById('profilePopup');
    if (!profilePopup) {
      console.error('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ä»–ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹ï¼ˆä½œå“ã€åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
    const workPopup = document.getElementById('workPopup');
    const adPopup = document.getElementById('adPopup');
    if (workPopup && workPopup.classList.contains('active')) {
      workPopup.classList.remove('active');
      setTimeout(() => {
        workPopup.style.display = 'none';
      }, 300);
    }
    if (adPopup && adPopup.classList.contains('active')) {
      adPopup.classList.remove('active');
      setTimeout(() => {
        adPopup.style.display = 'none';
      }, 300);
    }
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šï¼ˆå¸¸ã«æ›´æ–°ï¼‰
    const popupTitle = document.getElementById('profilePopupTitle');
    const popupDescription = document.getElementById('profilePopupDescription');
    const popupImage = profilePopup.querySelector('.profile-image-large');
    const popupMetaContainer = profilePopup.querySelector('.popup-meta');
    
    if (popupTitle) popupTitle.textContent = profileData.name;
    if (popupDescription) popupDescription.textContent = profileData.description;
    if (popupImage) {
      const imageSrc = (profileData.image && typeof profileData.image === 'object' && 'src' in profileData.image) 
        ? profileData.image.src 
        : (typeof profileData.image === 'string' ? profileData.image : '');
      popupImage.src = imageSrc;
    }
    // metaæƒ…å ±ã‚’å‹•çš„ã«ç”Ÿæˆ
    if (popupMetaContainer && profileData.meta && Array.isArray(profileData.meta)) {
      // æ—¢å­˜ã®spanè¦ç´ ã‚’å…¨ã¦å‰Šé™¤
      popupMetaContainer.innerHTML = '';
      // profileData.metaã®å„è¦ç´ ã«å¯¾ã—ã¦spanè¦ç´ ã‚’ç”Ÿæˆ
      profileData.meta.forEach((metaItem) => {
        const span = document.createElement('span');
        span.textContent = metaItem;
        popupMetaContainer.appendChild(span);
      });
    }
    
    // ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’è¡¨ç¤ºï¼ˆå¸¸ã«æ›´æ–°ï¼‰
    updateProfileCoinDisplay();
    
    // æ—¢ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆå†…å®¹æ›´æ–°ã®ã¿ï¼‰
    if (profilePopup.classList.contains('active')) {
      return;
    }
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆã‚ºãƒ¼ãƒ ã¯å‘¼ã³å‡ºã—å…ƒã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯è¡Œã‚ãªã„ï¼‰
      profilePopup.style.display = 'flex';
      setTimeout(() => {
        profilePopup.classList.add('active');
      }, 10);
  }

  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤ºé–¢æ•°
  function hideProfilePopup() {
    const profilePopup = document.getElementById('profilePopup');
    if (profilePopup && profilePopup.classList.contains('active')) {
      profilePopup.classList.remove('active');
      exitZoomMode();
    }
  }

  // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºé–¢æ•°
  function showAdPopup() {
    const adPopup = document.getElementById('adPopup');
    if (!adPopup) {
      console.error('åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ä»–ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹
    const workPopup = document.getElementById('workPopup');
    const profilePopup = document.getElementById('profilePopup');
    if (workPopup && workPopup.classList.contains('active')) {
      workPopup.classList.remove('active');
      setTimeout(() => {
        workPopup.style.display = 'none';
      }, 300);
    }
    if (profilePopup && profilePopup.classList.contains('active')) {
      profilePopup.classList.remove('active');
      setTimeout(() => {
        profilePopup.style.display = 'none';
      }, 300);
    }
    
    // æ—¢ã«åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (adPopup.classList.contains('active')) {
      return;
    }
    
    // åˆæœŸçŠ¶æ…‹ï¼šåºƒå‘Šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºã€åºƒå‘Šã‚³ãƒ³ãƒ†ãƒŠã¯éè¡¨ç¤º
    const adPrompt = document.getElementById('adPrompt');
    const adContainer = document.getElementById('adContainer');
    const customAdContainer = document.getElementById('customAdContainer');
    const adViewBtn = document.getElementById('adViewBtn');
    const adCloseBtn = document.getElementById('adCloseBtn');
    
    if (adPrompt) adPrompt.style.display = 'block';
    if (adContainer) adContainer.style.display = 'none';
    if (customAdContainer) customAdContainer.style.display = 'none';
    if (adViewBtn) adViewBtn.style.display = 'block';
    if (adCloseBtn) adCloseBtn.style.display = 'block';
    
    // åºƒå‘Šã‚³ãƒ³ãƒ†ãƒŠã®èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå†è¡¨ç¤ºæ™‚ã«å†èª­ã¿è¾¼ã¿ã§ãã‚‹ã‚ˆã†ã«ï¼‰
    if (adContainer) {
      adContainer.dataset.loaded = 'false';
    }
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    adPopup.style.display = 'flex';
    setTimeout(() => {
      adPopup.classList.add('active');
    }, 10);
    
    // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupAdPopupEvents();
  }

  // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—éè¡¨ç¤ºé–¢æ•°
  function hideAdPopup() {
    const adPopup = document.getElementById('adPopup');
    if (adPopup && adPopup.classList.contains('active')) {
      adPopup.classList.remove('active');
      exitZoomMode();
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰isEventLockedã‚’è§£é™¤
      isEventLocked = false;
    }
  }
  
  // åºƒå‘Šã‚’é–‹å§‹ã™ã‚‹é–¢æ•°ï¼ˆã€Œåºƒå‘Šã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹ï¼‰
  function startAd() {
    const adPrompt = document.getElementById('adPrompt');
    const adContainer = document.getElementById('adContainer');
    const adViewBtn = document.getElementById('adViewBtn');
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
    if (adPrompt) adPrompt.style.display = 'none';
    if (adViewBtn) adViewBtn.style.display = 'none';
    
    // åºƒå‘Šã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
    if (adContainer) {
      adContainer.style.display = 'block';
      
      // AdSenseåºƒå‘Šã‚’èª­ã¿è¾¼ã‚€ï¼ˆåˆå›ã®ã¿ï¼‰
      if (!adContainer.dataset.loaded || adContainer.dataset.loaded === 'false') {
        try {
          // AdSenseåºƒå‘Šã‚’åˆæœŸåŒ–
          const adsbygoogleScript = document.createElement('script');
          adsbygoogleScript.innerHTML = `
            (adsbygoogle = window.adsbygoogle || []).push({});
          `;
          document.body.appendChild(adsbygoogleScript);
          adContainer.dataset.loaded = 'true';
        } catch (e) {
          console.error('AdSenseåºƒå‘Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
        }
      }
    }
    
    // åºƒå‘Šè¦–è´å®Œäº†ã‚’æ¤œçŸ¥ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯åºƒå‘ŠAPIã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ç”¨ï¼‰
    // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«5ç§’å¾Œã«ãƒœãƒ¼ãƒŠã‚¹ã‚’é–‹å§‹ï¼ˆå®Ÿéš›ã¯åºƒå‘Šè¦–è´å®Œäº†æ™‚ã«å‘¼ã¶ï¼‰
    setTimeout(() => {
      activatePointBonus();
      // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      hideAdPopup();
    }, 5000); // 5ç§’å¾Œï¼ˆå®Ÿéš›ã¯åºƒå‘Šè¦–è´å®Œäº†æ™‚ã«å‘¼ã¶ï¼‰
  }
  
  // ãƒã‚¤ãƒ³ãƒˆå€å¢—ãƒœãƒ¼ãƒŠã‚¹ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
  function activatePointBonus() {
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (bonusTimer) {
      clearInterval(bonusTimer);
    }
    
    // ãƒœãƒ¼ãƒŠã‚¹ã‚’æœ‰åŠ¹åŒ–
    isPointBonusActive = true;
    bonusRemainingTime = BONUS_DURATION;
    
    // ãƒœãƒ¼ãƒŠã‚¹UIã‚’è¡¨ç¤º
    const bonusIndicator = document.getElementById('bonusIndicator');
    if (bonusIndicator) {
      bonusIndicator.style.display = 'flex';
    }
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
    updateBonusTimer();
    bonusTimer = setInterval(() => {
      bonusRemainingTime--;
      updateBonusTimer();
      
      if (bonusRemainingTime <= 0) {
        deactivatePointBonus();
      }
    }, 1000);
  }
  
  // ãƒã‚¤ãƒ³ãƒˆå€å¢—ãƒœãƒ¼ãƒŠã‚¹ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
  function deactivatePointBonus() {
    isPointBonusActive = false;
    bonusRemainingTime = 0;
    
    // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (bonusTimer) {
      clearInterval(bonusTimer);
      bonusTimer = null;
    }
    
    // ãƒœãƒ¼ãƒŠã‚¹UIã‚’éè¡¨ç¤º
    const bonusIndicator = document.getElementById('bonusIndicator');
    if (bonusIndicator) {
      bonusIndicator.style.display = 'none';
    }
  }
  
  // ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateBonusTimer() {
    const bonusTimeElement = document.getElementById('bonusTime');
    if (!bonusTimeElement) return;
    
    const minutes = Math.floor(bonusRemainingTime / 60);
    const seconds = bonusRemainingTime % 60;
    bonusTimeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  // åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupAdPopupEvents() {
    const adPopup = document.getElementById('adPopup');
    if (!adPopup) return;
    
    const closeButton = adPopup.querySelector('.popup-close-button');
    const closeBtn = document.getElementById('adCloseBtn');
    const viewBtn = document.getElementById('adViewBtn');
    
    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const closePopup = () => {
      hideAdPopup();
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰isEventLockedã‚’è§£é™¤
      isEventLocked = false;
      setTimeout(() => {
        if (adPopup) {
          adPopup.style.display = 'none';
        }
      }, 300);
    };
    
    if (closeButton) {
      closeButton.addEventListener('click', closePopup);
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closePopup);
    }
    
    // ã€Œåºƒå‘Šã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    if (viewBtn) {
      viewBtn.addEventListener('click', () => {
        startAd();
      });
    }
    
    // ESCã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
    const escKeyHandler = (e) => {
      if (e.key === 'Escape' && adPopup.classList.contains('active')) {
        closePopup();
      }
    };
    document.removeEventListener('keydown', escKeyHandler);
    document.addEventListener('keydown', escKeyHandler);
  }

  // ãƒ–ãƒ­ã‚°ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºé–¢æ•°
  function showBlogPopup(blogName) {
    const popup = document.getElementById('blogPopup');
    if (!popup) return;

    // --- Placeholder Content ---
    const blogData = {
      'ãƒ–ãƒ­ã‚°ã¯ã˜ã‚ã¾ã—ãŸ': {
        date: '2025.09.18',
        category: 'é›‘è¨˜',
        description: 'ã“ã®ãƒ–ãƒ­ã‚°ã®æœ€åˆã®è¨˜äº‹ã§ã™ã€‚ã“ã‚Œã‹ã‚‰æŠ€è¡“çš„ãªå†…å®¹ã‚„æ—¥ã€…ã®è€ƒãˆã‚’ç¶´ã£ã¦ã„ãã¾ã™ã€‚',
        image: 'https://picsum.photos/id/40/400/200',
      },
      'UIãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚³ãƒ„': {
        date: '2025.09.20',
        category: 'ãƒ‡ã‚¶ã‚¤ãƒ³',
        description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦åˆ†ã‹ã‚Šã‚„ã™ãã€ä½¿ã„ã‚„ã™ã„UIã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹ãŸã‚ã®ã„ãã¤ã‹ã®ã‚³ãƒ„ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚',
        image: 'https://picsum.photos/id/41/400/200',
      },
      'æœ€è¿‘èª­ã‚“ã æœ¬': {
        date: '2025.09.22',
        category: 'èª­æ›¸',
        description: 'æœ€è¿‘èª­ã‚“ã§é¢ç™½ã‹ã£ãŸãƒ“ã‚¸ãƒã‚¹æ›¸ã‚„å°èª¬ã«ã¤ã„ã¦ã®æ„Ÿæƒ³ã§ã™ã€‚',
        image: 'https://picsum.photos/id/42/400/200',
      }
    };
    const data = blogData[blogName] || { date: 'N/A', category: 'N/A', description: 'è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', image: '' };
    // --- End Placeholder ---

    popup.querySelector('#blogPopupTitle').textContent = blogName;
    popup.querySelector('#blogPopupDate').textContent = data.date;
    popup.querySelector('#blogPopupCategory').textContent = data.category;
    popup.querySelector('#blogPopupDescription').textContent = data.description;
    popup.querySelector('#blogPopupImage').innerHTML = `<img src="${data.image}" alt="${blogName}">`;

    popup.style.display = 'flex';
    setTimeout(() => {
      popup.classList.add('active');
    }, 10);

    // Setup close events
    const closePopup = () => {
      popup.classList.remove('active');
      exitZoomMode();
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰isEventLockedã‚’è§£é™¤
      isEventLocked = false;
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    };
    popup.querySelector('.popup-close-button').onclick = closePopup;
    popup.querySelector('.popup-close-btn').onclick = closePopup;
  }

  // ãƒã‚¤ãƒ³ãƒˆã«ã‚ºãƒ¼ãƒ ã™ã‚‹æ©Ÿèƒ½ã ã‘ã‚’æä¾›ã™ã‚‹é–¢æ•°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
  function zoomToPoint(pointName) {
    if (!pointName) return;
    
    // ç¾åœ¨ã®ã‚¿ã‚¦ãƒ³ã‚’å–å¾—ï¼ˆçµ±åˆå¾Œã¯åŸºæœ¬çš„ã«worksï¼‰
    const activeTownElement = document.querySelector('.town-list li.active a');
    const currentTownText = activeTownElement?.textContent?.trim().toLowerCase() || 'works';
    const currentTown = currentTownText.includes('profile') ? 'profile' : 
                        currentTownText.includes('works') ? 'works' : 
                        currentTownText.includes('blogs') ? 'blogs' : 'works';
    
    // æ—¢å­˜ã®è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹work-titleã‚’å…¨ã¦éè¡¨ç¤ºã«ã™ã‚‹
    document.querySelectorAll('.work-title').forEach(title => {
      title.classList.remove('title-visible');
    });
    
    // å¯¾å¿œã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’å–å¾—
    // worksã‚¿ã‚¦ãƒ³ã«çµ±åˆã—ãŸã®ã§ã€worksã‹ã‚‰å–å¾—ã‚’å„ªå…ˆ
    const townMap = pointOffsetMap['works'] || pointOffsetMap[currentTown] || pointOffsetMap['profile'];
    const pos = townMap[pointName];
    
    if (pos && cityGrid) {
      // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚’ã‚»ãƒƒãƒˆ
      isZoomed = true;
      zoomedPointName = pointName;
      
      // ã‚ºãƒ¼ãƒ ä¸­ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      document.body.classList.add('is-zoomed');
      
      // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’è¨­å®šï¼ˆä¸­å¤®ã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
      const camX = pos.x - 50;
      const camY = pos.y - 50;
      
      // ã‚«ãƒ¡ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¤ãƒ³ãƒˆã«ã‚ºãƒ¼ãƒ ï¼‰
      cityGrid.style.transition = 'transform 0.5s ease-out';
      cityGrid.style.transform = `rotateX(55deg) scale(2) translate(${-camX}%, ${-camY}%)`;
      
      // å¯¾å¿œã™ã‚‹ãƒã‚¤ãƒ³ãƒˆè¦ç´ ã‚’è¦‹ã¤ã‘ã¦ã€ãã®work-titleã‚’è¡¨ç¤º
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã®å ´åˆã¯data-profile-pointã§æ¤œç´¢
      let pointElement = null;
      if (pointName === 'profile') {
        pointElement = document.querySelector('.point-bubble[data-profile-point="true"]');
      } else if (pointName === 'ad') {
        pointElement = document.querySelector('.point-bubble[data-ad-point="true"]');
      } else {
        pointElement = document.querySelector(`.point-bubble[data-work-name="${pointName}"]`);
      }
      
      if (pointElement) {
        const workTitle = pointElement.querySelector('.work-title');
        if (workTitle) {
          // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
          workTitle.classList.add('title-visible');
          
          // 5ç§’å¾Œã«éè¡¨ç¤ºã«ã™ã‚‹
          setTimeout(() => {
            if (isZoomed && zoomedPointName === pointName) {
              workTitle.classList.remove('title-visible');
            }
          }, 5000);
        }
      }
    }
  }

  // ä½œå“æƒ…å ±ã‚’ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showWorkPopup(workName) {
    if (!workName) return;
    
    // ç¾åœ¨ã®ã‚¿ã‚¦ãƒ³ã‚’å–å¾—ï¼ˆzoomToPointé–¢æ•°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    const activeTownElement = document.querySelector('.town-list li.active a');
    const currentTownText = activeTownElement?.textContent?.trim().toLowerCase() || 'profile';
    const currentTown = currentTownText.includes('profile') ? 'profile' : 
                      currentTownText.includes('works') ? 'works' : 
                      currentTownText.includes('blogs') ? 'blogs' : 'profile';
    
    const popup = document.getElementById('workPopup');
    const popupTitle = document.getElementById('popupTitle');
    const popupType = document.getElementById('popupType');
    const popupScope = document.getElementById('popupScope');
    const popupDuration = document.getElementById('popupDuration');
    const popupDescription = document.getElementById('popupDescription');
    const popupImageContainer = document.querySelector('.popup-image-container');
    
    if (!popup || !popupTitle || !popupType || !popupScope || !popupDuration || !popupDescription || !popupImageContainer) {
      console.error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // ä»–ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ã‚‹ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰
    const profilePopup = document.getElementById('profilePopup');
    const adPopup = document.getElementById('adPopup');
    if (profilePopup && profilePopup.classList.contains('active')) {
      profilePopup.classList.remove('active');
      setTimeout(() => {
        profilePopup.style.display = 'none';
      }, 300);
    }
    if (adPopup && adPopup.classList.contains('active')) {
      adPopup.classList.remove('active');
      setTimeout(() => {
        adPopup.style.display = 'none';
      }, 300);
    }
    
    // ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é…ç½®
    const pointElement = document.querySelector(`.point-bubble[data-work-name="${workName}"]`);
    if (pointElement) {
      // ãƒã‚¤ãƒ³ãƒˆã®ç”»é¢ä¸Šã®ä½ç½®ã‚’å–å¾—
      const pointRect = pointElement.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // ãƒã‚¤ãƒ³ãƒˆãŒç”»é¢ã®å·¦åŠåˆ†ã«ã‚ã‚‹ã‹å³åŠåˆ†ã«ã‚ã‚‹ã‹ã§è¡¨ç¤ºä½ç½®ã‚’å¤‰æ›´
      const isPointOnLeftSide = (pointRect.left < viewportWidth / 2);

      
      // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å‚ç›´ä½ç½®ã‚’ãƒã‚¤ãƒ³ãƒˆã«åˆã‚ã›ã‚‹
      const viewportHeight = window.innerHeight;
      const pointCenterY = pointRect.top + (pointRect.height / 2);
      const normalizedY = Math.max(20, Math.min(viewportHeight - 20, pointCenterY));
      // popup.style.top = `${normalizedY}px`;
      // popup.style.transform = isPointOnLeftSide ? 
      //   `translateY(-50%) translateX(0)` : 
      //   `translateY(-50%) translateX(-120%)`;
    }
    
    // ä½œå“ã®è©³ç´°æƒ…å ± - å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
    const workDescriptions = worksData.descriptions;
    const workTypes = worksData.types;
    const workScopes = worksData.scopes;
    const workDurations = worksData.durations;
    
    // æ—¢å­˜ã®ä½œå“ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã€é–‰ã˜ãšã«å†…å®¹ã ã‘ã‚’æ›´æ–°ï¼ˆä½œå“ãƒã‚¤ãƒ³ãƒˆåŒå£«ã®åˆ‡ã‚Šæ›¿ãˆã®ä»•æ§˜ï¼‰
    const wasActive = popup.classList.contains('active');
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®å†…å®¹ã‚’æ›´æ–°ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
    popupTitle.textContent = `${workName} Co.`;
    const types = workTypes[workName];
    popupType.textContent = Array.isArray(types) ? types.join(' / ') : (types || 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ');
    const scopes = workScopes[workName];
    popupScope.textContent = Array.isArray(scopes) ? scopes.join(' / ') : (scopes || 'å€‹äººåˆ¶ä½œ');
    popupDuration.textContent = workDurations[workName] || 'åˆ¶ä½œæœŸé–“ä¸æ˜';
    popupDescription.textContent = workDescriptions[workName] || 'ã“ã®ä½œå“ã®è©³ç´°æƒ…å ±ã¯æº–å‚™ä¸­ã§ã™ã€‚';
    
    // ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¨­å®šï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—ï¼‰
    if (workName && worksData.images && worksData.images[workName]) {
      const image = worksData.images[workName];
      const imagePath = (image && typeof image === 'object' && 'src' in image) 
        ? image.src 
        : (typeof image === 'string' ? image : '');
      if (imagePath) {
      popupImageContainer.innerHTML = `<img src="${imagePath}" alt="${workName}" class="work-image-hamori">`;
      } else {
        popupImageContainer.innerHTML = `<div class="project-image-placeholder">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”»åƒ</div>`;
      }
    } else {
      popupImageContainer.innerHTML = `<div class="project-image-placeholder">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”»åƒ</div>`;
    }
    
    // ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’è¡¨ç¤ºï¼ˆå¸¸ã«æ›´æ–°ï¼‰
    updateWorkCoinDisplay(workName);
    
    // è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ›´æ–°ï¼ˆä½œå“ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸéš›ã«ã‚‚æ›´æ–°ã€City.astroã‹ã‚‰æ¥ãŸã“ã¨ã‚’ç¤ºã™ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
    const moreBtn = popup.querySelector('.popup-more-btn');
    if (moreBtn && workName) {
      moreBtn.href = `/works/${workName}?from=city`;
    }
    
    // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯é–‰ã˜ãšã«å†…å®¹ã ã‘æ›´æ–°ã€é–‹ã„ã¦ã„ãªã„å ´åˆã¯è¡¨ç¤º
    if (!wasActive) {
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
    popup.style.display = 'flex';
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
    setTimeout(() => {
      popup.classList.add('active');
    }, 10);
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupPopupEvents();
    }
    // æ—¢ã«é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã€å†…å®¹ãŒæ›´æ–°ã•ã‚ŒãŸã ã‘ã§ä½•ã‚‚ã—ãªã„ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯é–‹ã„ãŸã¾ã¾ï¼‰
  }
  
  // ä½œå“ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function updateWorkCoinDisplay(workName) {
    const counter = document.querySelector('#workPopup .popup-coin-worksgain-counter');
    if (counter) {
      const gainCount = worksCoinGains[workName] || 0;
      counter.textContent = gainCount.toString();
    }
    // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–ã‚’æ›´æ–°
    updateCoinGiveButton('work', workName);
  }
  
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function updateProfileCoinDisplay() {
    const counter = document.querySelector('#profilePopup .popup-coin-worksgain-counter');
    if (counter) {
      counter.textContent = profileCoinGains.toString();
    }
    // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–ã‚’æ›´æ–°
    updateCoinGiveButton('profile');
  }
  
  // ã‚³ã‚¤ãƒ³å¿œæ´ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ–ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateCoinGiveButton(type, workName = null) {
    const popup = type === 'work' ? document.getElementById('workPopup') : document.getElementById('profilePopup');
    if (!popup) return;
    
    const button = popup.querySelector('.popup-coin-give-btn');
    if (!button) return;
    
    // æ‰€æŒã‚³ã‚¤ãƒ³ãŒ1ä»¥ä¸Šã®å ´åˆã®ã¿æœ‰åŠ¹
    if (coinCount >= 1) {
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
      button.classList.remove('disabled');
    } else {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
      button.classList.add('disabled');
    }
  }
  
  // ã‚³ã‚¤ãƒ³å¿œæ´ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹é–¢æ•°
  function setCoinGiveButtonLoading(type, isLoading, workName = null) {
    const popup = type === 'work' ? document.getElementById('workPopup') : document.getElementById('profilePopup');
    if (!popup) return;
    
    const button = popup.querySelector('.popup-coin-give-btn');
    if (!button) return;
    
    if (isLoading) {
      button.disabled = true;
      button.classList.add('loading');
      // ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’éè¡¨ç¤º
      const buttonTexts = button.querySelectorAll('.popup-coin-give-btn-text');
      buttonTexts.forEach(text => {
        text.style.display = 'none';
      });
      // ã‚¢ã‚¤ã‚³ãƒ³ã‚‚éè¡¨ç¤º
      const buttonIcon = button.querySelector('.popup-coin-give-btn-icon');
      if (buttonIcon) {
        buttonIcon.style.display = 'none';
      }
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆã¾ã ãªã„å ´åˆï¼‰
      if (!button.querySelector('.loading-spinner')) {
        const spinner = document.createElement('div');
        spinner.className = 'loading-spinner';
        button.appendChild(spinner);
      }
    } else {
      button.classList.remove('loading');
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ã‚’å‰Šé™¤
      const spinner = button.querySelector('.loading-spinner');
      if (spinner) {
        spinner.remove();
      }
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’å†è¡¨ç¤º
      const buttonTexts = button.querySelectorAll('.popup-coin-give-btn-text');
      buttonTexts.forEach(text => {
        text.style.display = '';
      });
      // ã‚¢ã‚¤ã‚³ãƒ³ã‚‚å†è¡¨ç¤º
      const buttonIcon = button.querySelector('.popup-coin-give-btn-icon');
      if (buttonIcon) {
        buttonIcon.style.display = '';
      }
      // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°
      updateCoinGiveButton(type, workName);
    }
  }
  
    // ã‚³ã‚¤ãƒ³å¿œæ´æ©Ÿèƒ½
  async function supportWithCoin(type, workName = null) {
    // æ‰€æŒã‚³ã‚¤ãƒ³ãŒ1æœªæº€ã®å ´åˆã¯å‡¦ç†ã—ãªã„
    if (coinCount < 1) {
      return;
    }
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’é–‹å§‹
    setCoinGiveButtonLoading(type, true, workName);
    
    try {
      // ã‚³ã‚¤ãƒ³ã‚’1ã¤æ¸›ã‚‰ã™ï¼ˆUIã‚’å…ˆã«æ›´æ–°ï¼‰
      coinCount--;
      updateCoinCounter();
      
      // ã‚³ã‚¤ãƒ³ç²å¾—æ•°ã‚’å¢—ã‚„ã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°ï¼‰
      if (type === 'work' && workName) {
        worksCoinGains[workName] = (worksCoinGains[workName] || 0) + 1;
        updateWorkCoinDisplay(workName);
      } else if (type === 'profile') {
        profileCoinGains++;
        updateProfileCoinDisplay();
      }
      
      // Firestoreã«ä¿å­˜ï¼ˆæˆåŠŸã™ã‚‹ã¾ã§å¾…ã¤ï¼‰
      await saveCoinGains(type, workName);
      
      // ä¿å­˜ãŒæˆåŠŸã—ãŸã‚‰ã€ã‚³ã‚¤ãƒ³ãŒç”»é¢ã«æº¢ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
      createCoinBurstAnimation(type === 'work' ? document.getElementById('workPopup') : document.getElementById('profilePopup'));
    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€å¤‰æ›´ã‚’å…ƒã«æˆ»ã™
      console.error('ã‚³ã‚¤ãƒ³é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
      coinCount++; // ã‚³ã‚¤ãƒ³ã‚’æˆ»ã™
      updateCoinCounter();
      
      if (type === 'work' && workName) {
        worksCoinGains[workName] = Math.max(0, (worksCoinGains[workName] || 0) - 1);
        updateWorkCoinDisplay(workName);
      } else if (type === 'profile') {
        profileCoinGains = Math.max(0, profileCoinGains - 1);
        updateProfileCoinDisplay();
      }
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      alert('ã‚³ã‚¤ãƒ³ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    } finally {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è§£é™¤
      setCoinGiveButtonLoading(type, false, workName);
    }
  }
  
  // ã‚³ã‚¤ãƒ³ãŒç”»é¢ã«æº¢ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹ã‹ã‚‰ä¸Šã«ä¸ŠãŒã£ã¦ãã‚‹ï¼‰
  function createCoinBurstAnimation(popupElement) {
    if (!popupElement) return;
    
    // ã‚³ã‚¤ãƒ³ã®æ•°ã‚’æ±ºå®š
    const coinCount = 15;
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const startY = viewportHeight + 50; // ç”»é¢ä¸‹ã®å¤–ã‹ã‚‰é–‹å§‹
    const endY = viewportHeight * 0.6; // ç”»é¢ã®ä¸Šã‚ãŸã‚Š
    
    for (let i = 0; i < coinCount; i++) {
      setTimeout(() => {
        const coin = document.createElement('div');
        coin.className = 'coin-burst';
        // coinImageã¯define:varsã§æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯srcãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
        const coinSrc = (coinImage && typeof coinImage === 'object' && 'src' in coinImage) 
          ? coinImage.src 
          : (typeof coinImage === 'string' ? coinImage : '');
        coin.innerHTML = `<img src="${coinSrc}" alt="ã‚³ã‚¤ãƒ³" class="coin-burst-image">`;
        
        // ç”»é¢ã®å¹…ã«ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®ï¼ˆå·¦å³ã«å°‘ã—ä½™ç™½ï¼‰
        const startX = viewportWidth * 0 + Math.random() * (viewportWidth * 1);
        const endX = startX + (Math.random() - 0.5) * 50; // å°‘ã—æ¨ªã«ãšã‚Œã‚‹
        
        // é–‹å§‹ä½ç½®ã‚’è¨­å®š
        coin.style.left = `${startX}px`;
        coin.style.top = `${startY}px`;
        
        // ç§»å‹•è·é›¢ã‚’è¨ˆç®—ï¼ˆç›¸å¯¾çš„ãªç§»å‹•é‡ï¼‰
        const deltaX = endX - startX;
        const deltaY = endY - startY;
        
        coin.style.setProperty('--delta-x', `${deltaX}px`);
        coin.style.setProperty('--delta-y', `${deltaY}px`);
        
        document.body.appendChild(coin);
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆæ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œï¼‰
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            coin.classList.add('active');
          });
        });
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«å‰Šé™¤
        setTimeout(() => {
          if (coin.parentNode) {
            coin.parentNode.removeChild(coin);
          }
        }, 2000);
      }, i * 30); // å°‘ã—ãšã¤ãšã‚‰ã—ã¦ç™ºå°„
    }
  }

  // ã‚¿ã‚¦ãƒ³ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ©Ÿèƒ½
  function setupTownSwitching() {
    const townLinks = document.querySelectorAll('.town-list a');
    
    townLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const href = link.getAttribute('href');
        if (href) {
          // ãƒšãƒ¼ã‚¸é·ç§»å‰ã®ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          document.body.classList.add('page-transition');
          
          // ã‚¿ã‚¦ãƒ³åˆ‡ã‚Šæ›¿ãˆã®è¦–è¦šåŠ¹æœ
          if (cityView) {
            cityView.style.opacity = '0';
            cityView.style.transform = 'scale(0.95)';
          }
          
          // å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰å®Ÿéš›ã®ãƒšãƒ¼ã‚¸é·ç§»
          setTimeout(() => {
            window.location.href = href;
          }, 300);
          
          e.preventDefault();
        }
      });
    });
  }
  
  // ä½ç½®ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®è¨­å®š
  function setupResetPositionButton() {
    const resetButton = document.getElementById('reset-position');
    resetButton?.addEventListener('click', function() {
      // ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã‚’è§£é™¤
      isZoomed = false;
      zoomedPointName = null;
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
      personX = 50; // åˆæœŸXä½ç½®ï¼ˆ%ï¼‰
      personY = 70; // åˆæœŸYä½ç½®ï¼ˆ%ï¼‰
      
      // ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
      cameraX = 0;
      cameraY = 0;
      
      // ä½ç½®ã‚’æ›´æ–°
      updatePosition();
      
      // ã‚ºãƒ¼ãƒ ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.body.classList.remove('is-zoomed');
      
      // cityGridã«åˆæœŸä½ç½®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      if (cityGrid) {
        cityGrid.classList.add('reset-transition');
        cityGrid.style.transform = `rotateX(55deg) scale(1.8) translate(${-cameraX}%, ${-cameraY}%)`;
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        setTimeout(() => {
          cityGrid.classList.remove('reset-transition');
        }, 500);
      }
      
      // ã‚ºãƒ¼ãƒ ãŒãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸã®ã§ã€å…¨ã¦ã®work-titleã‚’éè¡¨ç¤ºã«
      document.querySelectorAll('.work-title').forEach(title => {
        title.classList.remove('title-visible');
      });
      
      // ãƒ¯ãƒ¼ã‚¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
      const workPopup = document.getElementById('workPopup');
      if (workPopup && workPopup.classList.contains('active')) {
        workPopup.classList.remove('active');
        setTimeout(() => {
          workPopup.style.display = 'none';
        }, 300);
      }
      
      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚‚é–‰ã˜ã‚‹
      const profilePopup = document.getElementById('profilePopup');
      if (profilePopup && profilePopup.classList.contains('active')) {
        profilePopup.classList.remove('active');
        setTimeout(() => {
          profilePopup.style.display = 'none';
        }, 300);
      }
    });
  }
  
  // å»ºç‰©ã®ä½ç½®ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®šã™ã‚‹é–¢æ•°
  function setupBuildings() {
    const buildings = document.querySelectorAll('.building');
    buildings.forEach((building, index) => {
      // å»ºç‰©ã«IDã‚’è¨­å®š
      building.setAttribute('id', `building-${index + 1}`);
      building.classList.add('interactive');
      
      // å»ºç‰©ã®ç¨®é¡ã‚’åˆ¤å®š
      const isMegastructure = building.classList.contains('megastructure');
      const isLeftSide = building.classList.contains('left-row');
      const isRightSide = building.classList.contains('right-row');
      const isRuined = building.classList.contains('ruined-building') || building.querySelector('.ruins');
      
      // å·¦å´ã®å»ºç‰©ã®å ´åˆ
      if (isLeftSide) {
        // å·¦å´ã®å»ºç‰©ç•ªå·ã‚’å–å¾—ï¼ˆåŒã˜ã‚¯ãƒ©ã‚¹ã®ä½•ç•ªç›®ã‹ï¼‰
        const leftBuildings = document.querySelectorAll('.left-row');
        const leftIndex = Array.from(leftBuildings).indexOf(building);
        
        // ä¸€åˆ—ã«æ•´ç„¶ã¨ä¸¦ã¹ã‚‹ - é“è·¯ã¨ã®é–“éš”ã‚’èª¿æ•´
        let left = 28; // é“è·¯ã‹ã‚‰ã®è·é›¢ã‚’ã•ã‚‰ã«é›¢ã™
        let top = 15 + (leftIndex * 25); // é–“éš”ã‚’ã•ã‚‰ã«åºƒã’ã‚‹
        
        // å»ºç‰©ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const buildingEl = building;
        buildingEl.style.left = `${left}%`;
        buildingEl.style.top = `${top}%`;
        buildingEl.style.zIndex = `${20 - leftIndex}`; // z-indexã®å€¤ã‚’ä¸Šã’ã‚‹
        
        // å„å»ºç‰©ã‚’å°‘ã—ãšã¤ãšã‚‰ã—ã¦é…ç½®
        const offsetX = leftIndex % 2 === 0 ? -2 : 0;
        buildingEl.style.transform = `translateX(${offsetX}%)`;
      }
      // å³å´ã®å»ºç‰©ã®å ´åˆ
      else if (isRightSide) {
        // å³å´ã®å»ºç‰©ç•ªå·ã‚’å–å¾—
        const rightBuildings = document.querySelectorAll('.right-row');
        const rightIndex = Array.from(rightBuildings).indexOf(building);
        
        // ä¸€åˆ—ã«æ•´ç„¶ã¨ä¸¦ã¹ã‚‹ - é“è·¯ã¨ã®é–“éš”ã‚’èª¿æ•´
        let left = 66; // é“è·¯ã‹ã‚‰ã®è·é›¢ã‚’ã•ã‚‰ã«é›¢ã™
        let top = 15 + (rightIndex * 25); // é–“éš”ã‚’ã•ã‚‰ã«åºƒã’ã‚‹
        
        // å»ºç‰©ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const buildingEl = building;
        buildingEl.style.left = `${left}%`;
        buildingEl.style.top = `${top}%`;
        buildingEl.style.zIndex = `${20 - rightIndex}`; // z-indexã®å€¤ã‚’ä¸Šã’ã‚‹
        
        // å„å»ºç‰©ã‚’å°‘ã—ãšã¤ãšã‚‰ã—ã¦é…ç½®
        const offsetX = rightIndex % 2 === 0 ? 2 : 0;
        buildingEl.style.transform = `translateX(${offsetX}%)`;
      }
      
      // å»ºç‰©ã®é«˜ã•ã‚’å‡ä¸€ã«è¨­å®š
      let height;
      
      if (isMegastructure) {
        height = 400; // å·¨å¤§å»ºç¯‰ç‰©ã®é«˜ã•ã‚’å°‘ã—æŠ‘ãˆã‚‹
      } else if (building.classList.contains('building-tall')) {
        height = 280; // é«˜ã„ãƒ“ãƒ«ã®é«˜ã•ã‚’å°‘ã—æŠ‘ãˆã‚‹
      } else if (building.classList.contains('building-small')) {
        height = 110;  // å°ã•ã„ãƒ“ãƒ«ã‚‚å°‘ã—æŠ‘ãˆã‚‹
      } else if (isRuined) {
        height = 180; // å´©å£Šã—ãŸå»ºç‰©
      } else {
        height = 160; // æ¨™æº–ãƒ“ãƒ«
      }
      
      // å»ºç‰©ã®é«˜ã•ã‚’è¨­å®š
      const buildingEl = building;
      buildingEl.style.height = `${height}px`;
      
      // å¹…ã‚’è¨­å®š
      if (isMegastructure) {
        // å·¨å¤§å»ºç¯‰ç‰©ã¯å¹…ã‚‚å¤§ãã
        buildingEl.style.width = `120px`;
      } else if (building.classList.contains('building-wide')) {
        buildingEl.style.width = `100px`;
      } else if (building.classList.contains('building-small')) {
        buildingEl.style.width = `50px`;
      } else {
        buildingEl.style.width = `70px`;
      }
      
      // å»ƒå¢Ÿã®å ´åˆã¯å‚¾ãã‚’åŠ ãˆã‚‹
      const ruins = building.querySelector('.ruins');
      if (isRuined || ruins) {
        const tiltDegree = (Math.random() * 5) - 2.5;
        const currentTransform = buildingEl.style.transform || '';
        buildingEl.style.transform = `${currentTransform} rotateZ(${tiltDegree}deg)`;
      }
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      buildingEl.addEventListener('click', function(e) {
        e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
        showBuildingInfo(buildingEl.id);
      });
    });
  }
  
  // ãã®ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…ç½®
  function setupObjects() {
    // è¿½åŠ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…ç½®
    const objects = document.querySelectorAll('.object:not(.debris):not(.wild-plant)');
    objects.forEach((object) => {
      const x = 10 + Math.random() * 80;
      const y = 10 + Math.random() * 80;
      
      const objectEl = object;
      objectEl.style.left = `${x}%`;
      objectEl.style.top = `${y}%`;
      
      // å›è»¢ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¨­å®š
      if (object.classList.contains('car')) {
        const rotation = Math.random() * 360;
        objectEl.style.transform = `rotateZ(${rotation}deg)`;
      }
    });
    
    // å»ƒæ£„ç‰©ã®é…ç½®
    const debris = document.querySelectorAll('.debris');
    debris.forEach((item) => {
      const x = 20 + Math.random() * 60;
      const y = 20 + Math.random() * 60;
      
      const debrisEl = item;
      debrisEl.style.left = `${x}%`;
      debrisEl.style.top = `${y}%`;
      
      const rotation = Math.random() * 360;
      debrisEl.style.transform = `rotateZ(${rotation}deg)`;
    });
    
    // é‡ç”Ÿæ¤ç‰©ã®é…ç½®
    const plants = document.querySelectorAll('.wild-plant');
    plants.forEach((plant) => {
      const x = 10 + Math.random() * 80;
      const y = 10 + Math.random() * 80;
      
      const plantEl = plant;
      plantEl.style.left = `${x}%`;
      plantEl.style.top = `${y}%`;
      
      const scale = 0.8 + Math.random() * 0.4;
      plantEl.style.transform = `scale(${scale})`;
    });
  }

  // ä½œå“ã”ã¨ã®ãƒã‚¤ãƒ³ãƒˆä½ç½®ãƒãƒƒãƒ—ï¼ˆ%ï¼‰- worksã‚¿ã‚¦ãƒ³ã«çµ±åˆ
  const pointOffsetMap = {
    'works': {
      ...worksData.positions,
      'profile': profileData.position, // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã®ä½ç½®ã‚’worksã‚¿ã‚¦ãƒ³ã«è¿½åŠ 
      'ad': { x: 40, y: 90 } // åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®ä½ç½®
    },
    // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼ˆå°†æ¥çš„ã«å‰Šé™¤å¯èƒ½ï¼‰
    'profile': {
      'profile': profileData.position
    },
    'blogs': {
      'ãƒ–ãƒ­ã‚°ã¯ã˜ã‚ã¾ã—ãŸ': { x: 40, y: 30 },
      'UIãƒ‡ã‚¶ã‚¤ãƒ³ã®ã‚³ãƒ„': { x: 70, y: 50 },
      'æœ€è¿‘èª­ã‚“ã æœ¬': { x: 30, y: 70 },
    }
  };
  
  // æ–°ã—ã„ã‚³ã‚¤ãƒ³ã‚’1ã¤ç”Ÿæˆã™ã‚‹é–¢æ•°
  function createSingleCoin() {
    const coinsContainer = document.getElementById('coinsContainer');
    if (!coinsContainer) {
      console.error('coinsContainer not found');
      return null;
    }
    
    // æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒˆä½ç½®ã‚’å–å¾—ï¼ˆé‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚ï¼‰
    const existingPositions = [];
    const townMap = pointOffsetMap['works'];
    Object.values(townMap).forEach(pos => {
      if (pos && typeof pos === 'object' && 'x' in pos && 'y' in pos) {
        existingPositions.push({ x: pos.x, y: pos.y });
      }
    });
    
    // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ã‚¤ãƒ³ã®ä½ç½®ã‚‚å–å¾—
    const visibleCoins = document.querySelectorAll('.coin:not(.collected)');
    visibleCoins.forEach(coinEl => {
      const left = parseFloat(coinEl.style.left);
      const top = parseFloat(coinEl.style.top);
      if (!isNaN(left) && !isNaN(top)) {
        existingPositions.push({ x: left, y: top });
      }
    });
    
    let coinX, coinY;
    let attempts = 0;
    const MIN_DISTANCE = 8; // æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒˆã¨ã®æœ€å°è·é›¢ï¼ˆ%ï¼‰
    
    // æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒˆã¨é‡ãªã‚‰ãªã„ä½ç½®ã‚’æ¢ã™
    do {
      coinX = 15 + Math.random() * 70; // 15%ï½85%ã®ç¯„å›²
      coinY = 15 + Math.random() * 70; // 15%ï½85%ã®ç¯„å›²
      
      // æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒˆã¨ã®è·é›¢ã‚’ãƒã‚§ãƒƒã‚¯
      const tooClose = existingPositions.some(pos => {
        const distance = Math.sqrt(Math.pow(coinX - pos.x, 2) + Math.pow(coinY - pos.y, 2));
        return distance < MIN_DISTANCE;
      });
      
      if (!tooClose) break;
      attempts++;
    } while (attempts < 50); // æœ€å¤§50å›è©¦è¡Œ
    
    const coinId = `coin-${coinIdCounter++}`;
    const coinData = {
      id: coinId,
      x: coinX,
      y: coinY,
      collected: false
    };
    coins.push(coinData);
    
    // ã‚³ã‚¤ãƒ³è¦ç´ ã‚’ä½œæˆï¼ˆç”»åƒã‚’ä½¿ç”¨ï¼‰
    const coinElement = document.createElement('div');
    coinElement.className = 'coin coin-spawning';
    coinElement.id = coinId;
    coinElement.setAttribute('data-coin-id', coinId);
    coinElement.style.left = `${coinX}%`;
    coinElement.style.top = `${coinY}%`;
    
    // å›è»¢ç”¨ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œæˆ
    const coinRotateWrapper = document.createElement('div');
    coinRotateWrapper.className = 'coin-rotate-wrapper';
    
    // ã‚³ã‚¤ãƒ³ç”»åƒã‚’è¿½åŠ 
    const coinImg = document.createElement('img');
    // coinImageã¯define:varsã§æ¸¡ã•ã‚Œã‚‹ãŸã‚ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯srcãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ç”¨
    coinImg.src = (coinImage && typeof coinImage === 'object' && 'src' in coinImage) 
      ? coinImage.src 
      : (typeof coinImage === 'string' ? coinImage : '');
    coinImg.alt = 'ã‚³ã‚¤ãƒ³';
    coinImg.className = 'coin-image';
    coinRotateWrapper.appendChild(coinImg);
    coinElement.appendChild(coinRotateWrapper);
    
    coinsContainer.appendChild(coinElement);
    
    // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ï¼ˆæ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œï¼‰
    requestAnimationFrame(() => {
      // coin-spawningã‚¯ãƒ©ã‚¹ãŒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      setTimeout(() => {
        coinElement.classList.remove('coin-spawning');
      }, 1200); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã¨åŒã˜
    });
    
    return coinData;
  }
  
  // è¡¨ç¤ºä¸­ã®ã‚³ã‚¤ãƒ³æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  function getVisibleCoinCount() {
    const visibleCoins = document.querySelectorAll('.coin:not(.collected)');
    return visibleCoins.length;
  }
  
  // ã‚³ã‚¤ãƒ³ã‚’è£œå……ã™ã‚‹é–¢æ•°ï¼ˆæœ€å¤§3ã¤ã«ãªã‚‹ã¾ã§ï¼‰
  function respawnCoins() {
    const visibleCount = getVisibleCoinCount();
    const needed = MAX_VISIBLE_COINS - visibleCount;
    
    if (needed > 0) {
      for (let i = 0; i < needed; i++) {
        createSingleCoin();
      }
    }
  }
  
  // ã‚³ã‚¤ãƒ³ã‚’é…ç½®ã™ã‚‹é–¢æ•°ï¼ˆåˆæœŸè¡¨ç¤ºæ™‚ã®ã¿ï¼‰
  function setupCoins() {
    // åˆæœŸè¡¨ç¤ºã¯æœ€å¤§3ã¤
    for (let i = 0; i < MAX_VISIBLE_COINS; i++) {
      createSingleCoin();
    }
  }
  
  // ã€Œ+1ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showCoinGainAnimation(gain = 1) {
    const coinCounter = document.getElementById('coinCounter');
    if (!coinCounter) {
      console.error('coinCounter not found for gain animation');
      return;
    }
    
    // ã€Œ+1ã€ã¾ãŸã¯ã€Œ+2ã€è¦ç´ ã‚’ä½œæˆ
    const gainElement = document.createElement('div');
    gainElement.className = 'coin-gain-indicator';
    gainElement.textContent = `+${gain}`;
    
    // ã‚³ã‚¤ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®ä½ç½®ã‚’å–å¾—
    const counterRect = coinCounter.getBoundingClientRect();
    gainElement.style.left = `${counterRect.right + 6}px`;
    gainElement.style.top = `${counterRect.top + counterRect.height / 2}px`;
    gainElement.style.transform = 'translateY(-50%)';
    
    // bodyã«è¿½åŠ 
    document.body.appendChild(gainElement);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆæ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§å®Ÿè¡Œã—ã¦ç¢ºå®Ÿã«è¡¨ç¤ºï¼‰
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        gainElement.classList.add('active');
      });
    });
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«è¦ç´ ã‚’å‰Šé™¤ï¼ˆ1ç§’å¾Œï¼‰
    setTimeout(() => {
      if (gainElement && gainElement.parentNode) {
        gainElement.parentNode.removeChild(gainElement);
      }
    }, 1000);
  }
  
  // ã‚³ã‚¤ãƒ³æ•°ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateCoinCounter() {
    const coinCountText = document.getElementById('coinCountText');
    if (coinCountText) {
      coinCountText.textContent = coinCount.toString();
    } else {
      console.error('coinCountText element not found!');
    }
  }

  // è¡çªåˆ¤å®šé–¢æ•°ã®è¿½åŠ 
  // ãƒã‚¤ãƒ³ãƒˆã¨ã®è¡çªåˆ¤å®šã‚’è¡Œã„ã€åå‰ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function checkPointCollision() {
    if (!person) return;

    const personRect = person.getBoundingClientRect();
    const bubbles = document.querySelectorAll('.point-bubble');
    
    let foundItemName = null;
    let foundItemType = null;

    for (const bubble of bubbles) {
      // ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„è¦ç´ ã¯ç„¡è¦–
      if (bubble.offsetParent === null) continue;

      const bubbleRect = bubble.getBoundingClientRect();
      const overlap = !(personRect.right < bubbleRect.left || 
                        personRect.left > bubbleRect.right || 
                        personRect.bottom < bubbleRect.top || 
                        personRect.top > bubbleRect.bottom);

      if (overlap) {
        if (bubble.dataset.workName) {
            foundItemName = bubble.dataset.workName;
            foundItemType = 'work';
        } else if (bubble.dataset.profilePoint) {
            foundItemName = 'profile';
            foundItemType = 'profile';
        } else if (bubble.dataset.adPoint) {
            foundItemName = 'ad';
            foundItemType = 'ad';
        } else if (bubble.dataset.blogName) {
            foundItemName = bubble.dataset.blogName;
            foundItemType = 'blog';
        }
        break;
      }
    }

    if (foundItemName && foundItemName !== collidingWork) {
      collidingWork = foundItemName;
      if (!isZoomed) {
        isEventLocked = true;
        
        // ç§»å‹•ã‚’å³åº§ã«åœæ­¢
        moveDirectionX = 0;
        moveDirectionY = 0;
        inertiaVelocityX = 0;
        inertiaVelocityY = 0;
        isMoving = false;
        isTouching = false;
        if (touchAnimationFrameId) {
          cancelAnimationFrame(touchAnimationFrameId);
          touchAnimationFrameId = null;
        }
        
        if (foundItemType === 'work') {
            zoomToPoint(foundItemName);
            setTimeout(() => {
              if (isZoomed && zoomedPointName === foundItemName) {
                showWorkPopup(foundItemName);
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é–“ã¯isEventLockedã‚’ç¶­æŒï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¾ã§ï¼‰
              }
            }, 600);
        } else if (foundItemType === 'profile') {
            // ä½œå“ãƒã‚¤ãƒ³ãƒˆã¨åŒã˜å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼šã¾ãšã‚ºãƒ¼ãƒ ã€ãã®å¾Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            zoomToPoint(foundItemName);
            setTimeout(() => {
              if (isZoomed && zoomedPointName === foundItemName) {
                showProfilePopup();
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é–“ã¯isEventLockedã‚’ç¶­æŒï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¾ã§ï¼‰
              }
            }, 600);
        } else if (foundItemType === 'ad') {
            // åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®å‡¦ç†ï¼šã¾ãšã‚ºãƒ¼ãƒ ã€ãã®å¾Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
            zoomToPoint(foundItemName);
            setTimeout(() => {
              if (isZoomed && zoomedPointName === foundItemName) {
                showAdPopup();
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é–“ã¯isEventLockedã‚’ç¶­æŒï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¾ã§ï¼‰
              }
            }, 600);
        } else if (foundItemType === 'blog') {
            zoomToPoint(foundItemName);
            setTimeout(() => {
              if (isZoomed && zoomedPointName === foundItemName) {
                showBlogPopup(foundItemName);
                // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹é–“ã¯isEventLockedã‚’ç¶­æŒï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¾ã§ï¼‰
              }
            }, 600);
        }
      }
    } else if (!foundItemName) {
      collidingWork = null;
    }
  }

  // ä½œå“æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ï¼ˆäº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ï¼‰
  function showWorkInfo(workName) {
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’ä»£ã‚ã‚Šã«ä½¿ç”¨
    showWorkPopup(workName);
  }

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  function setupPopupEvents() {
    const popup = document.getElementById('workPopup');
    const closeButton = popup?.querySelector('.popup-close-button');
    const closeBtn = popup?.querySelector('.popup-close-btn');
    const moreBtn = popup?.querySelector('.popup-more-btn');
    const coinGiveBtn = popup?.querySelector('.popup-coin-give-btn');
    
    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    const closePopup = () => {
      if (popup) {
        popup.classList.remove('active');
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚‚çµ‚äº†
        exitZoomMode();
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‰ã˜ã‚‰ã‚ŒãŸã‚‰isEventLockedã‚’è§£é™¤
        isEventLocked = false;
        
        setTimeout(() => {
          if (popup) {
            popup.style.display = 'none';
          }
        }, 300);
      }
    };
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    const newCloseButton = closeButton?.cloneNode(true);
    const newCloseBtn = closeBtn?.cloneNode(true);
    const newMoreBtn = moreBtn?.cloneNode(true);
    
    if (closeButton && newCloseButton) {
      closeButton.parentNode?.replaceChild(newCloseButton, closeButton);
      newCloseButton.addEventListener('click', closePopup);
    }
    
    if (closeBtn && newCloseBtn) {
      closeBtn.parentNode?.replaceChild(newCloseBtn, closeBtn);
      newCloseBtn.addEventListener('click', closePopup);
    }
    
    if (moreBtn && newMoreBtn) {
      moreBtn.parentNode?.replaceChild(newMoreBtn, moreBtn);
      // ä½œå“è©³ç´°ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®šï¼ˆCity.astroã‹ã‚‰æ¥ãŸã“ã¨ã‚’ç¤ºã™ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
      const currentWorkName = document.getElementById('popupTitle')?.textContent?.replace(' Co.', '') || '';
      if (currentWorkName) {
        newMoreBtn.href = `/works/${currentWorkName}?from=city`;
      }
    }
    
    // ã‚³ã‚¤ãƒ³å¿œæ´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    if (coinGiveBtn) {
      const newCoinGiveBtn = coinGiveBtn.cloneNode(true);
      coinGiveBtn.parentNode?.replaceChild(newCoinGiveBtn, coinGiveBtn);
      newCoinGiveBtn.addEventListener('click', () => {
        const currentWorkName = document.getElementById('popupTitle')?.textContent?.replace(' Co.', '') || '';
        if (currentWorkName) {
          supportWithCoin('work', currentWorkName);
        }
      });
    }
    
    // ESCã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹ï¼ˆã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯é‡è¤‡ã—ãªã„ã‚ˆã†ã«ä¸€åº¦ã ã‘è¨­å®šï¼‰
    document.removeEventListener('keydown', escKeyHandler);
    document.addEventListener('keydown', escKeyHandler);
  }

  // ESCã‚­ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°
  const escKeyHandler = (e) => {
    const popup = document.getElementById('workPopup');
    if (e.key === 'Escape' && popup?.classList.contains('active')) {
      if (popup) {
        popup.classList.remove('active');
        
        // ESCã‚­ãƒ¼ã§ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ãŸå ´åˆã‚‚ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
        exitZoomMode();
        
        setTimeout(() => {
          if (popup) {
            popup.style.display = 'none';
          }
        }, 300);
      }
    }
  };
</script>

<style>
  /* ãƒ«ãƒ¼ãƒˆè¦ç´ ã§ãƒ†ãƒ¼ãƒå¤‰æ•°ã‚’å®šç¾© */
  :root {
    /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
    --bg-gradient-start: #e8e8e8;
    --bg-gradient-end: #d0d0d0;
    --ground-color: #e0e0e0;
    --ground-line-color: rgba(180, 180, 180, 0.3);
    --ground-shadow: rgba(0,0,0,0.1);
    --building-front: #e5e5e5;
    --building-border: #d8d8d8;
    --building-side: #d8d8d8;
    --building-top: #f0f0f0;
    --ruins-color: #d5d5d5;
    --ruins-detail: rgba(150, 150, 150, 0.2);
    --road-color: #c5c5c5;
    --road-line: rgba(255, 255, 255, 0.8);
    --debris-color: #c0c0c0;
    --plant-color: #a8b8a8;
    --car-color: #b5b5b5;
    --person-color: #909090;
    --text-color: #333;
    --controls-bg: rgba(220, 220, 220, 0.8);
    --panel-bg: rgba(240, 240, 240, 0.8);
  }
  
  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
  html.dark-theme {
    --bg-gradient-start: #a3a3a3;
    --bg-gradient-end: #5a5a5a;
    --ground-color: #505050;
    --ground-line-color: rgba(100, 100, 100, 0.3);
    --ground-shadow: rgba(0,0,0,0.2);
    --building-front: #5a5a5a;
    --building-border: #4a4a4a;
    --building-side: #4d4d4d;
    --building-top: #6a6a6a;
    --ruins-color: #4a4a4a;
    --ruins-detail: rgba(30, 30, 30, 0.3);
    --road-color: #333333;
    --road-line: rgba(255, 255, 255, 0.3);
    --debris-color: #555;
    --plant-color: #567356;
    --car-color: #5d5d5d;
    --person-color: #e0e0e0;
    --text-color: #e0e0e0;
    --controls-bg: rgba(60, 60, 60, 0.8);
    --panel-bg: rgba(40, 40, 40, 0.7);
  }
  
  .city {
    width: 100%;
    height: 100lvh;
    display: flex;
    flex-direction: column;
    background-color: #f5f5f5;
  }
  
  .elem1{
    background-color: #000;
  }
  
  header {
    padding: 1rem;
    color: #333;
    z-index: 100;
  }
  
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  h1 {
    font-size: 1.5rem;
    margin: 0;
    font-weight: bold;
  }
  
  .town-name {
    position: absolute;
    left: 20px;
    top: 20px;
    font-size: 0.9rem;
    font-weight: 200;
    letter-spacing: 1.5px;
    color: var(--text-color);
    opacity: 0.8;
    padding: 0.3rem 0.6rem;
    border-radius: 20px;
    transition: all 0.3s ease;
    z-index: 200;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }
  
  .town-name:hover {
    opacity: 1;
  }
  
  html.dark-theme .town-name {
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }
  
  .city-view {
    position: relative;
    flex: 1;
    overflow: hidden;
    background: linear-gradient(180deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
    perspective: 1500px;
  }
  
  .city-grid {
    width: 100%;
    height: 100%;
    position: absolute;
    transform-style: preserve-3d;
    transition: transform 0.1s ease-out;
    transform-origin: center center;
    transform: rotateX(55deg) scale(1.8);
  }
  
  .city-grid.reset-transition {
    transition: transform 0.5s ease-out;
  }
  
  .ground {
    position: absolute;
    width: 300%;
    height: 300%;
    left: -100%;
    top: -100%;
    background-color: var(--ground-color);
    background-image: 
      linear-gradient(to right, var(--ground-line-color) 1px, transparent 1px),
      linear-gradient(to bottom, var(--ground-line-color) 1px, transparent 1px);
    background-size: 40px 40px;
    box-shadow: inset 0 0 40px var(--ground-shadow);
  }
  
  .building {
    position: absolute;
    width: 60px;
    height: 60px;
    transform-style: preserve-3d;
    transform: translateZ(0);
  }
  
  .building-small {
    width: 30px;
    height: 30px;
  }
  
  .building-front, .building-side, .building-top {
    position: absolute;
    box-shadow: 0 0 15px rgba(0,0,0,0.05);
  }
  
  .building-front {
    width: 100%;
    height: 100%;
    transform-origin: bottom center;
    background-color: var(--building-front);
    border-left: 1px solid var(--building-border);
    border-right: 1px solid var(--building-border);
  }
  
  /* ãƒ‹ãƒ¼ã‚¢ã‚ªãƒ¼ãƒˆãƒã‚¿é¢¨ã®å»ƒå¢Ÿãƒ†ã‚¯ã‚¹ãƒãƒ£ */
  .building-front.ruins {
    background-color: var(--ruins-color);
    background-image: 
      linear-gradient(90deg, var(--ruins-detail) 0%, transparent 20%, transparent 80%, var(--ruins-detail) 100%),
      linear-gradient(to bottom, var(--ruins-detail) 0%, transparent 20%, transparent 80%, var(--ruins-detail) 100%);
  }
  
  .building-front.ruins::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background-image: 
      radial-gradient(circle at 30% 40%, var(--ruins-detail) 0%, transparent 30%),
      radial-gradient(circle at 70% 60%, var(--ruins-detail) 0%, transparent 20%);
    z-index: 1;
  }
  
  .building-side {
    width: 20px;
    height: 100%;
    right: -20px;
    transform-origin: left center;
    transform: rotateY(90deg);
    background-color: var(--building-side);
  }
  
  .building-side.ruins {
    background-color: var(--ruins-color);
    filter: brightness(0.9);
  }
  
  .building-top {
    width: 100%;
    height: 20px;
    top: -5px;
    transform-origin: bottom center;
    transform: rotateX(-90deg);
    background-color: var(--building-top);
  }
  
  .building-tall {
    height: 80px;
    z-index: 5;
  }
  
  .building-wide {
    width: 100px;
  }
  
  /* å·¨å¤§å»ºç¯‰ç‰©ï¼ˆãƒ¡ã‚¬ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¼ï¼‰ */
  .megastructure {
    z-index: 6;
  }
  
  /* ãƒ¡ã‚¤ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸­å¤®ã®å¤§ããªé“è·¯ï¼‰ */
  .road.main-road {
    position: absolute;
    width: 80px;
    height: 300%;
    top: -100%;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--road-color);
    z-index: 2;
    /* box-shadow: 0 0 15px var(--ground-shadow); */
  }
  
  .road.main-road::after {
    content: '';
    position: absolute;
    width: 3px;
    height: 100%;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    background-color: var(--road-line);
  }
  
  /* äº¤å·®é“è·¯ */
  .road.cross-road-1, .road.cross-road-2 {
    position: absolute;
    height: 25px;
    width: 200%;
    left: -50%;
    background-color: var(--road-color);
    z-index: 1;
    /* box-shadow: 0 0 12px var(--ground-shadow); */
  }
  
  .road.cross-road-1 {
    top: 30%;
  }
  
  .road.cross-road-2 {
    top: 60%;
  }
  
  /* å»ƒæ£„ç‰©ã‚„ç“¦ç¤« */
  .debris {
    width: 20px;
    height: 20px;
    position: absolute;
    z-index: 4;
  }
  
  .debris-1 {
    background-color: var(--debris-color);
    clip-path: polygon(0% 0%, 100% 0%, 80% 100%, 20% 100%);
  }
  
  .debris-2 {
    background-color: var(--debris-color);
    filter: brightness(1.05);
    clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
  }
  
  /* è’å»ƒåœ°ã«ç”Ÿãˆã‚‹æ¤ç‰© */
  .wild-plant {
    position: absolute;
    width: 15px;
    height: 15px;
    z-index: 3;
  }
  
  .wild-plant::before {
    content: '';
    position: absolute;
    width: 15px;
    height: 15px;
    background-color: var(--plant-color);
    clip-path: polygon(50% 0%, 65% 35%, 100% 35%, 75% 60%, 85% 100%, 50% 80%, 15% 100%, 25% 60%, 0% 35%, 35% 35%);
  }
  
  /* å´©å£Šã—ãŸè»Šä¸¡ */
  .car.rusted-car {
    width: 25px;
    height: 12px;
    background-color: var(--car-color);
    border-radius: 2px;
    position: absolute;
    z-index: 4;
  }
  
  .car.rusted-car::before, .car.rusted-car::after {
    content: '';
    position: absolute;
    width: 6px;
    height: 6px;
    background-color: var(--car-color);
    filter: brightness(0.9);
    border-radius: 50%;
  }
  
  .car.rusted-car::before {
    left: 3px;
    bottom: -2px;
  }
  
  .car.rusted-car::after {
    right: 3px;
    bottom: -2px;
  }
  
  /* è¿½åŠ ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ */
  .object {
    position: absolute;
    transform-style: preserve-3d;
    z-index: 5;
  }
  
  /* äººå‹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .person {
    position: absolute;
    width: 20px;
    height: 20px;
    transform: translate(-50%, -50%);
    z-index: 100;
  }
  
  .person-body {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
  }
  
  .person-head {
    position: absolute;
    width: 8px;
    height: 8px;
    background-color: var(--person-color);
    border-radius: 50%;
    left: 6px;
    top: -2px;
    z-index: 3;
  }
  
  .person-torso {
    position: absolute;
    width: 10px;
    height: 14px;
    background-color: var(--person-color);
    filter: brightness(0.9);
    left: 5px;
    top: 5px;
    z-index: 2;
  }
  
  .person-leg {
    position: absolute;
    width: 4px;
    height: 10px;
    background-color: var(--person-color);
    filter: brightness(0.8);
    bottom: -10px;
    transform-origin: top center;
  }
  
  .person-leg.left {
    left: 5px;
  }
  
  .person-leg.right {
    left: 11px;
  }
  
  .person-arm {
    position: absolute;
    width: 3px;
    height: 8px;
    background-color: var(--person-color);
    filter: brightness(0.8);
    top: 6px;
    transform-origin: top center;
  }
  
  .person-arm.left {
    left: 2px;
  }
  
  .person-arm.right {
    right: 2px;
  }
  
  .person-shadow {
    position: absolute;
    width: 12px;
    height: 4px;
    background-color: rgba(0,0,0,0.15);
    border-radius: 50%;
    bottom: -14px;
    left: 4px;
    filter: blur(1px);
  }
  
  /* ãƒ†ãƒ¼ãƒåˆ‡æ›¿ãƒœã‚¿ãƒ³ */
  .theme-switcher {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 200;
    display: flex;
    flex-direction: row;
    gap: 10px;
  }
  
  .theme-switcher button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--panel-bg);
    border: 1px solid rgba(150, 150, 150, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    color: var(--text-color);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }
  
  .theme-switcher button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
  }
  
  .theme-switcher button:active {
    transform: translateY(0);
  }
  
  /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¯view-toggle-btnã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ!importantã§ç¢ºå®Ÿã«ä¸Šæ›¸ãï¼‰ */
  .theme-switcher button.theme-toggle-btn {
    width: auto !important;
    height: auto !important;
    border-radius: 24px !important;
    padding: 4px !important;
    background: #ffffff !important;
    border: 1px solid #cdcdcd !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    box-shadow: none !important;
  }
  
  html.dark-theme .theme-switcher button.theme-toggle-btn {
    background: rgba(30, 30, 35, 0.8) !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
  }
  
  .theme-switcher button.theme-toggle-btn:hover {
    background: #f5f5f5 !important;
    transform: none !important;
    box-shadow: none !important;
  }
  
  html.dark-theme .theme-switcher button.theme-toggle-btn:hover {
    background: rgba(40, 40, 45, 0.9) !important;
  }
  
  .toggle-theme-icons {
    display: flex;
    gap: 2px;
  }
  
  .toggle-theme-icons img {
    width: 16px;
    height: 16px;
    padding: 8px;
    border-radius: 16px;
    transition: all 0.2s;
    object-fit: contain;
  }
  
  .toggle-theme-icons .theme-icon-light {
    background: #ffffff;
    border: 1px solid #e2e2e2;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
  }
  
  html.dark-theme .toggle-theme-icons .theme-icon-light {
    background: transparent;
    border: none;
    box-shadow: none;
    opacity: 0.5;
  }
  
  .toggle-theme-icons .theme-icon-dark {
    background: transparent;
    border: none;
    box-shadow: none;
    opacity: 0.5;
  }
  
  html.dark-theme .toggle-theme-icons .theme-icon-dark {
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
    opacity: 1;
  }
  
  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç™½ã«ã™ã‚‹ */
  html.dark-theme .toggle-theme-icons .theme-icon-light {
    filter: brightness(0) invert(1);
  }
  
  html.dark-theme .toggle-theme-icons .theme-icon-dark {
    filter: brightness(0) invert(1);
  }
  
  .reset-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
  
  .reset-icon img {
    width: 14px;
    height: 14px;
    object-fit: contain;
  }
  
  /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã«ä½ç½®ãƒªã‚»ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ç™½ã«ã™ã‚‹ */
  html.dark-theme .reset-icon img {
    filter: brightness(0) invert(1);
  }
  
  #reset-position:hover .reset-icon {
    animation: pulse 1s ease infinite;
  }
  
  @keyframes pulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.1);
    }
    100% {
      transform: scale(1);
    }
  }
  
  .controls {
    position: absolute;
    bottom: 20px;
    left: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 200;
  }
  
  /* PCç”¨: WASDãƒœã‚¿ãƒ³ */
  .controls-desktop {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨: ä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤ºï¼‰ */
  .controls-mobile {
    display: none;
  }
  
  .controls-row {
    display: flex;
  }
  
  .controls button {
    width: 40px;
    height: 40px;
    margin: 5px;
    border-radius: 8px;
    background-color: var(--controls-bg);
    border: 1px solid var(--building-border);
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    color: var(--text-color);
  }
  
  .controls button:hover {
    filter: brightness(1.05);
  }
  
  .controls button:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  /* ä»®æƒ³ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .joystick-base {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background-color: rgba(225, 225, 225, 0.6);
    border: 1px solid rgba(150, 150, 150, 0.4);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
  }
  
  html.dark-theme .joystick-base {
    background-color: rgba(40, 40, 40, 0.8);
    border-color: rgba(100, 100, 100, 0.4);
  }
  
  .joystick-stick {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(150, 150, 150, 0.5);
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: transform 0.1s ease-out;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.2);
    pointer-events: none;
  }
  
  html.dark-theme .joystick-stick {
    background-color: rgba(100, 100, 100, 0.9);
    border-color: rgba(150, 150, 150, 0.5);
  }
  
  .joystick-stick.active {
    transition: none;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘èª¿æ•´ */
  @media (max-width: 768px) {
    /* PCç”¨ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º */
    .controls-desktop {
      display: none;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚’è¡¨ç¤º */
    .controls-mobile {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .joystick-base {
      width: 80px;
      height: 80px;
    }
    
    .joystick-stick {
      width: 36px;
      height: 36px;
    }
    
    .theme-toggle-btn {
      padding: 3px;
    }
    
    .toggle-theme-icons img {
      width: 14px;
      height: 14px;
      padding: 6px;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ã‚³ã‚¤ãƒ³ã‚µã‚¤ã‚ºã‚’å¤§ããã™ã‚‹ */
    :global(.coin) {
      width: 40px;
      height: 40px;
    }
  }
  
  /* å»ºç‰©ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åŒ– */
  .building.interactive {
    cursor: pointer;
    transition: transform 0.3s ease, filter 0.3s ease;
  }
  
  .building.interactive:hover {
    transform: translateZ(20px) scale(1.05);
    filter: brightness(1.2);
    z-index: 10;
  }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« - æ´—ç·´ã•ã‚ŒãŸSaaSã‚¹ã‚¿ã‚¤ãƒ« */
  .building-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    overflow: hidden;
    opacity: 0;
    pointer-events: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’é€šéã•ã›ã‚‹ */
    transition: opacity 0.3s ease;
    align-items: center;
    justify-content: center;
  }
  
  .building-modal.active {
    opacity: 1;
    pointer-events: auto; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã«ã‚¯ãƒªãƒƒã‚¯ã‚’æ¤œçŸ¥ */
  }
  
  .modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  
  .modal-content {
    position: relative;
    width: 90%;
    max-width: 500px;
    background-color: var(--panel-bg);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    transform: translateY(30px) scale(0.95);
    opacity: 0;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
    z-index: 1001;
  }
  
  .building-modal.active .modal-content {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid rgba(226, 232, 240, 0.1);
  }
  
  .modal-body {
    padding: 24px;
  }
  
  #modalTitle {
    font-size: 20px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0;
    letter-spacing: -0.01em;
  }
  
  .close-button {
    background: transparent;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    color: var(--text-color);
    opacity: 0.6;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .close-button:hover {
    opacity: 1;
    background-color: rgba(226, 232, 240, 0.1);
  }
  
  .building-type {
    display: inline-block;
    font-size: 12px;
    font-weight: 500;
    color: #6366F1;
    background-color: rgba(99, 102, 241, 0.1);
    border-radius: 16px;
    padding: 4px 12px;
    margin-bottom: 16px;
    letter-spacing: 0.01em;
    text-transform: uppercase;
  }
  
  .building-description {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    opacity: 0.9;
    margin: 0;
  }

  /* å¹ãå‡ºã—ãƒã‚¤ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .point-bubble {
    position: absolute;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: rgba(255, 255, 255, 0.6);
    box-shadow: 0 0 15px rgba(255, 255, 255, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.8);
    cursor: pointer;
    z-index: 10;
    transition: all 0.3s ease;
    transform-style: preserve-3d;
    transform: translate(-50%, -50%) translateZ(5px);
  }

  .point-bubble::before {
    content: '';
    position: absolute;
    width: 10px;
    height: 10px;
    background-color: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    z-index: 2;
  }

  .point-bubble::after {
    content: '';
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.5);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation: pulse 2s infinite ease-out;
    z-index: 1;
  }

  .point-bubble:hover {
    background-color: rgba(255, 255, 255, 0.8);
    box-shadow: 0 0 20px rgba(255, 255, 255, 0.6), inset 0 0 15px rgba(255, 255, 255, 1);
    transform: translate(-50%, -50%) translateZ(10px) scale(1.1);
  }

  /* Profileã‚¿ã‚¦ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
  .point-bubble:not(.work-item) {
    background-color: rgba(228, 243, 255, 0.75);
    box-shadow: 0 0 15px rgba(120, 200, 255, 0.5), inset 0 0 10px rgba(180, 230, 255, 0.8);
    backdrop-filter: blur(3px);
    -webkit-backdrop-filter: blur(3px);
    border: 1px solid rgba(255, 255, 255, 0.8);
  }

  .point-bubble:not(.work-item)::before {
    width: 8px;
    height: 8px;
    background-color: rgba(100, 190, 255, 0.95);
    box-shadow: 0 0 8px rgba(100, 190, 255, 0.9);
  }

  .point-bubble:not(.work-item)::after {
    border: 1px solid rgba(150, 210, 255, 0.6);
    width: 50px;
    height: 50px;
    animation: subtlePulse 3s infinite ease-out;
  }

  .point-bubble:not(.work-item):hover {
    background-color: rgba(230, 245, 255, 0.85);
    box-shadow: 0 0 25px rgba(120, 200, 255, 0.7), inset 0 0 15px rgba(180, 230, 255, 1);
    transform: translate(-50%, -50%) translateZ(10px) scale(1.08);
  }

  /* Blogsã‚¿ã‚¦ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« - ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚ˆã‚Šå¾Œã«é…ç½®ã—ã¦å„ªå…ˆåº¦ã‚’é«˜ãã™ã‚‹ */
  .point-bubble:not(.work-item)[data-work-name] {
    background: linear-gradient(135deg, rgba(245, 245, 245, 0.8), rgba(235, 235, 245, 0.8));
    box-shadow: 0 0 15px rgba(150, 150, 200, 0.4), inset 0 0 10px rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.9);
  }

  .point-bubble:not(.work-item)[data-work-name]::before {
    background-color: rgba(130, 150, 255, 0.95);
    box-shadow: 0 0 8px rgba(130, 150, 255, 0.9);
  }

  .point-bubble:not(.work-item)[data-work-name]::after {
    border-color: rgba(180, 190, 255, 0.7);
  }

  .point-bubble:not(.work-item)[data-work-name]:hover {
    background: linear-gradient(135deg, rgba(250, 250, 255, 0.9), rgba(240, 240, 255, 0.9));
    box-shadow: 0 0 20px rgba(150, 150, 220, 0.6), inset 0 0 15px rgba(255, 255, 255, 1);
  }

  .point-bubble.interactive {
    cursor: pointer;
  }

  @keyframes pulse {
    0% {
      width: 60px;
      height: 60px;
      opacity: 0.6;
    }
    70% {
      width: 90px;
      height: 90px;
      opacity: 0.2;
    }
    100% {
      width: 60px;
      height: 60px;
      opacity: 0.6;
    }
  }

  @keyframes subtlePulse {
    0% {
      width: 50px;
      height: 50px;
      opacity: 0.5;
    }
    70% {
      width: 65px;
      height: 65px;
      opacity: 0.2;
    }
    100% {
      width: 50px;
      height: 50px;
      opacity: 0.5;
    }
  }

  /* ãƒã‚¤ãƒ³ãƒˆé…ç½®ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¤ãƒ³ãƒˆä½ç½® - å…¨ã‚¿ã‚¦ãƒ³å…±é€šåŸºæœ¬è¨­å®š */
  .point-1, .point-2, .point-3, .point-4, .point-5, .point-6,
  .point-7, .point-8, .point-9, .point-10, .point-11, .point-12 {
    animation-delay: 0s;
  }

  .town-profile .point-1 { left: 20%; top: 100%; animation-delay: 0.4s; }
  .town-profile .point-2 { left: 70%; top: 30%; animation-delay: 0.4s; }
  .town-profile .point-3 { left: 25%; top: 45%; animation-delay: 0.8s; }
  .town-profile .point-4 { left: 75%; top: 50%; animation-delay: 1.2s; }
  .town-profile .point-5 { left: 30%; top: 70%; animation-delay: 1.6s; }
  .town-profile .point-6 { left: 65%; top: 75%; animation-delay: 2s; }
  .town-profile .point-7 { left: 45%; top: 40%; animation-delay: 2.4s; }
  .town-profile .point-8 { left: 60%; top: 50%; animation-delay: 2.8s; }
  .town-profile .point-9 { left: 20%; top: 60%; animation-delay: 3.2s; }
  .town-profile .point-10 { left: 80%; top: 65%; animation-delay: 3.6s; }
  .town-profile .point-11 { left: 40%; top: 50%; animation-delay: 4s; }
  .town-profile .point-12 { left: 60%; top: 20%; animation-delay: 4.4s; }

  /* Worksã‚¿ã‚¦ãƒ³ç”¨ã®ãƒã‚¤ãƒ³ãƒˆä½ç½® - JavaScriptã§å‹•çš„ã«è¨­å®šã•ã‚Œã‚‹ãŸã‚å‰Šé™¤
  .town-works .point-1 { left: 60%; top: 65%; animation-delay: 0s; } 
  .town-works .point-2 { left: 75%; top: 35%; animation-delay: 0.4s; } 
  .town-works .point-3 { left: 35%; top: 40%; animation-delay: 0.8s; } 
  .town-works .point-4 { left: 45%; top: 75%; animation-delay: 1.2s; } 
  .town-works .point-5 { left: 24%; top: 64%; animation-delay: 1.6s; } 
  .town-works .point-6 { left: 58%; top: 45%; animation-delay: 2s; } 
  .town-works .point-7 { left: 55%; top: 90%; animation-delay: 2.4s; }
  .town-works .point-8 { left: 40%; top: 60%; animation-delay: 2.8s; }
  .town-works .point-9 { left: 50%; top: 80%; animation-delay: 3.2s; }
  .town-works .point-10 { left: 40%; top: 90%; animation-delay: 3.6s; }
  .town-works .point-11 { left: 35%; top: 95%; animation-delay: 4s; }
  .town-works .point-12 { left: 68%; top: 85%; animation-delay: 4.4s; }
  */
  
  /* Worksã‚¿ã‚¦ãƒ³ã§ã¯ã€JavaScriptã§worksData.positionsã‹ã‚‰å‹•çš„ã«ä½ç½®ã‚’è¨­å®š */
  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ã®ã¿è¨­å®š */
  .town-works .point-1 { animation-delay: 0s; }
  .town-works .point-2 { animation-delay: 0.4s; }
  .town-works .point-3 { animation-delay: 0.8s; }
  .town-works .point-4 { animation-delay: 1.2s; }
  .town-works .point-5 { animation-delay: 1.6s; }
  .town-works .point-6 { animation-delay: 2s; }
  .town-works .point-7 { animation-delay: 2.4s; }
  .town-works .point-8 { animation-delay: 2.8s; }
  .town-works .point-9 { animation-delay: 3.2s; }
  .town-works .point-10 { animation-delay: 3.6s; }
  .town-works .point-11 { animation-delay: 4s; }
  .town-works .point-12 { animation-delay: 4.4s; }

  /* Blogsã‚¿ã‚¦ãƒ³ç”¨ã®ãƒã‚¤ãƒ³ãƒˆä½ç½® */
  .town-blogs .point-1 { left: 40%; top: 20%; animation-delay: 0s; }
  .town-blogs .point-2 { left: 65%; top: 15%; animation-delay: 0.4s; }
  .town-blogs .point-3 { left: 20%; top: 30%; animation-delay: 0.8s; }
  .town-blogs .point-4 { left: 50%; top: 40%; animation-delay: 1.2s; }
  .town-blogs .point-5 { left: 80%; top: 30%; animation-delay: 1.6s; }
  .town-blogs .point-6 { left: 30%; top: 55%; animation-delay: 2s; }
  .town-blogs .point-7 { left: 70%; top: 55%; animation-delay: 2.4s; }
  .town-blogs .point-8 { left: 25%; top: 75%; animation-delay: 2.8s; }
  .town-blogs .point-9 { left: 45%; top: 65%; animation-delay: 3.2s; }
  .town-blogs .point-10 { left: 60%; top: 75%; animation-delay: 3.6s; }
  .town-blogs .point-11 { left: 85%; top: 70%; animation-delay: 4s; }
  .town-blogs .point-12 { left: 75%; top: 45%; animation-delay: 4.4s; }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒæ™‚ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’èª¿æ•´ */
  html.dark-theme .point-bubble {
    background-color: rgba(120, 190, 255, 0.7);
    box-shadow: 0 0 15px rgba(100, 170, 255, 0.6), inset 0 0 10px rgba(150, 200, 255, 0.9);
  }

  html.dark-theme .point-bubble::before {
    background-color: rgba(180, 220, 255, 0.95);
    box-shadow: 0 0 10px rgba(150, 200, 255, 0.9);
  }

  html.dark-theme .point-bubble::after {
    border: 2px solid rgba(150, 210, 255, 0.7);
    box-shadow: 0 0 8px rgba(100, 180, 255, 0.5);
  }

  html.dark-theme .point-bubble:hover {
    background-color: rgba(140, 200, 255, 0.85);
    box-shadow: 0 0 25px rgba(100, 170, 255, 0.8), inset 0 0 15px rgba(180, 220, 255, 1);
  }

  /* ã‚¿ã‚¦ãƒ³ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .town-list {
    position: absolute;
    left: 20px;
    top: 80px;
    z-index: 200;
  }

  .town-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .town-list li {
    margin-bottom: 12px;
    opacity: 0.6;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
  }

  .town-list li:hover {
    opacity: 0.9;
  }

  .town-list li.active {
    opacity: 1;
  }

  .town-list .bullet {
    margin-right: 6px;
    font-size: 1.2em;
    color: var(--text-color);
    width: 10px;
    display: inline-block;
    text-align: center;
  }

  .town-list .placeholder {
    width: 10px;
    margin-right: 6px;
    display: inline-block;
  }

  .town-list a {
    color: var(--text-color);
    text-decoration: none;
    font-size: 0.8rem;
    font-weight: 300;
    letter-spacing: 1px;
    transition: all 0.2s ease;
  }

  .town-list li.active a {
    font-size: 0.9rem;
    font-weight: 500;
    letter-spacing: 0.8px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  html.dark-theme .town-list li.active a {
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
  }

  /* ãƒšãƒ¼ã‚¸é·ç§»ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  .page-transition {
    pointer-events: none;
  }
  
  .city-view {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  /* ä½œå“è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« - Works Townç”¨ */
  .work-item {
    position: absolute; /* relativeã‹ã‚‰absoluteã«å¤‰æ›´ã—ã¦ä½ç½®ã‚’ç¶­æŒ */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 20;
  }

  .work-item::before {
    display: none;
  }

  .work-item::after {
    width: 50px;
    height: 50px;
    border-color: rgba(200, 200, 255, 0.6);
    z-index: 1;
  }

  .work-image {
    width: 90%;
    aspect-ratio: 1/1;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 3;
  }

  /* ä½œå“ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
  .work-title {
    position: absolute;
    width: 100px;
    left: 50%;
    transform: translateX(-50%);
    top: -24px;
    text-align: center;
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-color);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    background-color: rgba(255, 255, 255, 0.85);
    padding: 2px 6px;
    border-radius: 10px;
    pointer-events: none;
  }

  .work-title.title-visible {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
  }

  /* ãƒã‚¤ãƒ³ãƒˆãƒ›ãƒãƒ¼æ™‚ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤ºï¼ˆã™ã¹ã¦ã®ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œï¼‰ */
  .point-bubble:hover .work-title {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
    z-index: 1000;
  }

  /* å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ */
  .work-item:hover .work-title {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
    z-index: 1000;
  }

  html.dark-theme .work-title {
    background-color: rgba(50, 50, 70, 0.85);
  }

  /* å„ä½œå“ã®ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§è¨­å®šï¼ˆworksDataã‹ã‚‰å–å¾—ï¼‰ */
  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆã®ç”»åƒã‚‚ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§è¨­å®šï¼ˆprofileDataã‹ã‚‰å–å¾—ï¼‰ */

  .work-type {
    display: inline-block;
    font-size: 12px;
    font-weight: 500;
    color: #4F46E5;
    background-color: rgba(79, 70, 229, 0.1);
    border-radius: 16px;
    padding: 4px 12px;
    margin-bottom: 16px;
    letter-spacing: 0.01em;
    text-transform: uppercase;
  }

  .work-description {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text-color);
    opacity: 0.9;
    margin: 0 0 20px 0;
  }

  .work-details {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
  }

  .work-link {
    background-color: #4F46E5;
    color: white;
    padding: 8px 16px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
  }

  .work-link:hover {
    background-color: #4338CA;
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .work-link::after {
    content: 'â†’';
    margin-left: 6px;
  }

  /* Worksã‚¿ã‚¦ãƒ³ç”¨ã®ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚ºèª¿æ•´ */
  .point-bubble.work-item {
    width: 50px;
    height: 50px;
    overflow: visible;
    position: absolute;
  }

  .point-bubble.work-item::before {
    width: 6px;
    height: 6px;
    background-color: rgba(255, 255, 255, 0.9);
    z-index: 2;
  }

  .point-bubble.work-item::after {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(200, 200, 255, 0.6);
    animation: worksPulse 4s infinite ease-out;
    z-index: 1;
  }

  .point-bubble.work-item:hover {
    transform: translate(-50%, -50%) translateZ(8px) scale(1.1);
  }

  @keyframes worksPulse {
    0% {
      width: 40px;
      height: 40px;
      opacity: 0.7;
      border-width: 2px;
    }
    50% {
      width: 80px;
      height: 80px;
      opacity: 0.2;
      border-width: 1px;
    }
    100% {
      width: 40px;
      height: 40px;
      opacity: 0.7;
      border-width: 2px;
    }
  }

  /* ========================================
     Header (PortfolioViewã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«)
     ======================================== */
  .portfolio-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 0;
    margin: 0;
    transition: backdrop-filter 0.3s ease, -webkit-backdrop-filter 0.3s ease;
  }

  .portfolio-header.scrolled {
    background-color: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    transition: backdrop-filter 0.3s ease, -webkit-backdrop-filter 0.3s ease;
  }

  html.dark-theme .portfolio-header.scrolled {
    background-color: rgba(30, 30, 35, 0.8);
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 40px 8px;
    position: sticky;
    top: 0;
  }

  .logo-text {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color, #333);
    margin: 0;
    letter-spacing: 0.01em;
  }

  html.dark-theme .logo-text {
    color: var(--text-color, #e0e0e0);
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .social-links {
    display: flex;
    gap: 8px;
  }

  .social-link {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 1px solid rgba(226, 226, 226, 0.8);
    background: #ffffff;
    color: var(--text-color, #333);
    text-decoration: none;
    transition: all 0.2s;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
  }

  html.dark-theme .social-link {
    background: rgba(30, 30, 35, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--text-color, #e0e0e0);
  }

  .social-link:hover {
    background: #f5f5f5;
  }

  html.dark-theme .social-link:hover {
    background: rgba(40, 40, 45, 0.9);
  }

  .view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 4px;
    background: #ffffff;
    border: 1px solid #cdcdcd;
    border-radius: 24px;
    cursor: pointer;
    transition: all 0.2s;
  }

  html.dark-theme .view-toggle-btn {
    background: rgba(30, 30, 35, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .view-toggle-btn:hover {
    background: #f5f5f5;
  }

  html.dark-theme .view-toggle-btn:hover {
    background: rgba(40, 40, 45, 0.9);
  }

  .toggle-icons {
    display: flex;
    gap: 2px;
  }

  .toggle-icons svg {
    width: 16px;
    height: 16px;
    padding: 8px;
    border-radius: 16px;
    transition: all 0.2s;
  }

  .toggle-icons .icon-grid.active {
    background: #ffffff;
    border: 1px solid #e2e2e2;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
  }

  html.dark-theme .toggle-icons .icon-grid.active {
    background: rgba(50, 50, 60, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .toggle-icons .icon-3d.active {
    background: #ffffff;
    border: 1px solid #e2e2e2;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.15);
  }

  html.dark-theme .toggle-icons .icon-3d.active {
    background: rgba(50, 50, 60, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .toggle-icons .icon-3d {
    color: #808080;
  }

  /* Mobile Menu Button (Hidden on Desktop) */
  .mobile-menu-btn {
    display: none;
    flex-direction: column;
    justify-content: space-between;
    width: 20px;
    height: 16px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    z-index: 1001;
    transition: all 0.3s ease;
  }

  .hamburger-line {
    width: 100%;
    height: 1.5px;
    background-color: var(--text-color, #333);
    border-radius: 1px;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  html.dark-theme .hamburger-line {
    background-color: var(--text-color, #e0e0e0);
  }

  .mobile-menu-btn.active .hamburger-line:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .mobile-menu-btn.active .hamburger-line:nth-child(2) {
    opacity: 0;
    transform: translateX(-10px);
  }

  .mobile-menu-btn.active .hamburger-line:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* Mobile Menu Dropdown */
  .mobile-menu-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    z-index: 999;
    height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, visibility 0.3s ease;
    opacity: 0;
    visibility: hidden;
    box-shadow: none;
    pointer-events: none;
  }

  .mobile-menu-dropdown.active {
    height: auto;
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .mobile-menu-nav {
    display: flex;
    flex-direction: column;
    gap: 0;
    padding: 8px 0 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }

  .mobile-menu-view-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 24px;
    margin: 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  }

  .mobile-view-toggle-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-color, #808080);
    letter-spacing: 0.02em;
    flex-shrink: 0;
  }

  html.dark-theme .mobile-view-toggle-label {
    color: var(--text-color, #9CA3AF);
  }

  .mobile-view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 3px;
    background: var(--color-white, #ffffff);
    border: 1px solid #cdcdcd;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
    flex-shrink: 0;
  }

  html.dark-theme .mobile-view-toggle-btn {
    background: rgba(30, 30, 35, 0.8);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .mobile-view-toggle-btn:active {
    transform: scale(0.96);
    background: #f5f5f5;
  }

  html.dark-theme .mobile-view-toggle-btn:active {
    background: rgba(40, 40, 45, 0.9);
  }

  .mobile-toggle-icons {
    display: flex;
    gap: 2px;
  }

  .mobile-toggle-icons svg {
    width: 14px;
    height: 14px;
    padding: 6px;
    border-radius: 14px;
    transition: all 0.2s;
  }

  .mobile-toggle-icons .icon-grid.active {
    background: var(--color-white, #ffffff);
    border: 1px solid rgba(226, 226, 226, 0.8);
    box-shadow: 0 0 24px rgba(0, 0, 0, 0.12);
  }

  html.dark-theme .mobile-toggle-icons .icon-grid.active {
    background: rgba(50, 50, 60, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .mobile-toggle-icons .icon-3d.active {
    background: var(--color-white, #ffffff);
    border: 1px solid rgba(226, 226, 226, 0.8);
    box-shadow: 0 0 24px rgba(0, 0, 0, 0.12);
  }

  html.dark-theme .mobile-toggle-icons .icon-3d.active {
    background: rgba(50, 50, 60, 0.9);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .mobile-toggle-icons .icon-3d {
    color: var(--text-color, #808080);
  }

  .mobile-menu-social {
    display: flex;
    gap: 10px;
    margin: 8px 0 0;
    padding: 16px 24px 0;
    border-top: 1px solid rgba(0, 0, 0, 0.06);
  }

  .mobile-social-link {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 1px solid rgba(0, 0, 0, 0.08);
    background: rgba(255, 255, 255, 0.6);
    color: var(--text-color, #333);
    text-decoration: none;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }

  html.dark-theme .mobile-social-link {
    background: rgba(30, 30, 35, 0.6);
    border-color: rgba(255, 255, 255, 0.2);
    color: var(--text-color, #e0e0e0);
  }

  .mobile-social-link:active {
    background: rgba(255, 255, 255, 0.9);
    transform: scale(0.95);
    border-color: rgba(0, 0, 0, 0.12);
  }

  html.dark-theme .mobile-social-link:active {
    background: rgba(40, 40, 45, 0.9);
  }

  /* Mobile Portfolio List */
  .mobile-menu-portfolio {
    padding: 16px 24px;
    margin: 0;
  }

  html.dark-theme .mobile-menu-portfolio {
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .mobile-portfolio-title {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-color, #808080);
    margin: 0 0 12px;
    letter-spacing: 0.02em;
    text-transform: capitalize;
  }

  html.dark-theme .mobile-portfolio-title {
    color: var(--text-color, #9CA3AF);
  }

  .mobile-portfolio-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .mobile-portfolio-item {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .mobile-portfolio-button {
    width: 100%;
    padding: 10px 0px;
    background: rgba(255, 255, 255, 0.4);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-color, #333);
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.01em;
    text-align: left;
    font-family: inherit;
  }

  html.dark-theme .mobile-portfolio-button {
    background: rgba(30, 30, 35, 0.4);
    border-color: rgba(255, 255, 255, 0.1);
    color: var(--text-color, #e0e0e0);
  }

  .mobile-portfolio-button:active {
    background: rgba(255, 255, 255, 0.6);
    transform: scale(0.98);
    border-color: rgba(0, 0, 0, 0.1);
  }

  html.dark-theme .mobile-portfolio-button:active {
    background: rgba(40, 40, 45, 0.6);
    border-color: rgba(255, 255, 255, 0.15);
  }

  /* Header Responsive */
  @media (max-width: 768px) {
    /* Header - Mobile: Same behavior as PC (transparent by default, background on scroll) */
    .portfolio-header {
      background-color: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }

    .portfolio-header.scrolled {
      background-color: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    html.dark-theme .portfolio-header.scrolled {
      background-color: rgba(30, 30, 35, 0.8);
    }

    /* When menu is open, show background on header and menu */
    .portfolio-header.menu-open {
      background-color: rgba(255, 255, 255, 1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    html.dark-theme .portfolio-header.menu-open {
      background-color: rgba(30, 30, 35, 1);
    }

    .mobile-menu-dropdown {
      background-color: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      border-top: none;
    }

    /* When menu is active, show unified background */
    .mobile-menu-dropdown.active {
      background-color: rgba(255, 255, 255, 1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.04);
    }

    html.dark-theme .mobile-menu-dropdown.active {
      background-color: rgba(30, 30, 35, 1);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    /* Header - Mobile Layout: Logo Left, Hamburger Right */
    .header-container {
      padding: 16px 20px;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: center;
    }

    .header-logo {
      flex: 0 0 auto;
    }

    .logo-text {
      font-size: 13px;
      line-height: 1.2;
      font-weight: 500;
    }

    /* Hide desktop actions on mobile */
    .header-actions {
      display: none;
    }

    /* Show hamburger menu button */
    .mobile-menu-btn {
      display: flex;
    }

    /* Hide company-list on mobile (shown in mobile menu instead) */
    .company-list {
      display: none;
    }
  }

  /* ä¼šç¤¾ãƒªã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
  .company-list {
    position: absolute;
    top: 80px;
    right: 20px;
    z-index: 200;
    padding: 12px;
    border-radius: 8px;
  }
  .company-list h3 {
    margin: 0 0 8px;
    font-size: 0.8rem;
    color: var(--text-color);
    text-transform: capitalize;
  }
  .company-list ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }
  .company-list .company-item {
    margin-bottom: 6px;
    padding: 6px 12px;
    background: var(--panel-bg);
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
    color: var(--text-color);
    font-size: 0.7rem;
  }
  .company-list .company-item:hover {
    background: rgba(150,150,150,0.1);
    transform: translateX(2px);
  }

  /* Mobile: Hide company-list on mobile */
  @media (max-width: 768px) {
    .company-list {
      display: none;
    }
  }

  /* ãƒã‚¤ãƒ³ãƒˆåè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .point-name-display {
    position: absolute;
    padding: 5px 12px;
    background-color: rgba(255, 255, 255, 0.9);
    color: var(--text-color);
    border-radius: 20px;
    pointer-events: none;
    transform: translate(-50%, -50%);
    transition: opacity 0.3s ease;
    opacity: 0;
    font-size: 0.9rem;
    font-weight: 500;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    white-space: nowrap;
    z-index: 900;
    letter-spacing: 0.5px;
  }
  
  html.dark-theme .point-name-display {
    background-color: rgba(60, 60, 80, 0.9);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  }
  
  /* ã‚ºãƒ¼ãƒ çŠ¶æ…‹ã®è¡¨ç¤º */
  body.is-zoomed .controls {
    opacity: 0.7;
    transform: translateY(10px);
    transition: opacity 0.3s, transform 0.3s;
  }
  
  body.is-zoomed .controls:hover {
    opacity: 1;
    transform: translateY(0);
  }
  
  body.is-zoomed .town-list,
  body.is-zoomed .company-list,
  body.is-zoomed .theme-switcher {
    opacity: 0.5;
    transition: opacity 0.3s;
  }
  
  body.is-zoomed .town-list:hover,
  body.is-zoomed .company-list:hover,
  body.is-zoomed .theme-switcher:hover {
    opacity: 1;
  }
  
  /* ã‚ºãƒ¼ãƒ ä¸­ã§ã‚‚ãƒã‚¤ãƒ³ãƒˆãƒ›ãƒãƒ¼åŠ¹æœã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
  body.is-zoomed .point-bubble.work-item:hover .work-title {
    opacity: 1 !important;
    transform: translateX(-50%) translateY(-5px) !important;
    transition: opacity 0.3s, transform 0.3s !important;
    z-index: 1000 !important;
  }
  
  /* ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã®ã‚ºãƒ¼ãƒ æ™‚ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã */
  body.is-zoomed .point-bubble .work-title.title-visible {
    opacity: 1 !important;
    transform: translateX(-50%) translateY(-5px) !important;
    transition: opacity 0.3s, transform 0.3s !important;
    z-index: 1000 !important;
  }
  
  /* ã‚ºãƒ¼ãƒ ä¸­ã¯æ“ä½œãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º */
  body.is-zoomed .controls::before {
    content: "ç§»å‹•ã‚­ãƒ¼ã§ã‚ºãƒ¼ãƒ è§£é™¤";
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 12px;
    color: var(--text-color);
    background-color: var(--panel-bg);
    padding: 4px 8px;
    border-radius: 4px;
    white-space: nowrap;
    opacity: 0.8;
    pointer-events: none;
  }
  
  /* ã‚¹ãƒãƒ›å‘ã‘èª¿æ•´ */
  @media (max-width: 768px) {
    body.is-zoomed .controls::before {
      display: none;
    }
  }

  /* ä½œå“ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
  .work-popup {
    position: fixed;
    left: 4%;
    top: 50%;
    transform: translateY(-50%) translateX(-4%);
    width: 30%;
    background-color: rgba(255, 255, 255, 0.85);
    border-radius: 32px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    padding: 16px 24px;
  }

  .work-popup.active {
    transform: translateY(-50%) translateX(0);
  }

  .popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 8px;
    /* border-bottom: 1px solid rgba(0, 0, 0, 0.06); */
  }

  .popup-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #252528;
    letter-spacing: -0.01em;
  }

  .popup-close-button {
    background: none;
    border: none;
    cursor: pointer;
    color: #6B7280;
    padding: 8px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
  }

  .popup-close-button:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: #111827;
  }

  .popup-image-container {
    width: 100%;
    min-height: 120px;
    background-color: #F9FAFB;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9CA3AF;
    font-size: 0.9rem;
    overflow: hidden;
    margin-bottom: 16px;
    
    >img{
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 8px;
    }
  }

  .work-image-hamori {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  .project-image-placeholder {
    text-align: center;
    width: 100%;
  }

  .popup-meta {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    flex-wrap: wrap;
  }

  :global(.popup-meta span) {
    font-size: 0.7rem;
    font-weight: 500;
    color: #4F46E5;
    background-color: rgba(79, 70, 229, 0.08);
    padding: 4px 10px;
    border-radius: 20px;
    letter-spacing: 0.02em;
  }

  :global(#popupDescription) {
    font-size: 0.775rem;
    line-height: 1.6;
    color: #4B5563;
    margin: 0 4px 16px;
  }

  :global(.profile-popup-description) {
    font-size: 0.775rem;
    line-height: 1.6;
    color: #4B5563;
    margin: 0 4px 16px;
  }


  .popup-footer {
    margin-top: 24px;
    display: flex;
    gap: 12px;
  }

  .popup-close-btn, .popup-more-btn {
    padding: 9px 16px;
    border-radius: 16px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    outline: none;
  }

  .popup-close-btn {
    background-color: #F3F4F6;
    color: #374151;
    flex: 1;
  }

  .popup-more-btn {
    background-color: #4F46E5;
    color: white;
    flex: 2;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .popup-more-btn:visited {
    color: white;
  }

  .popup-close-btn:hover {
    background-color: #E5E7EB;
  }

  .popup-more-btn:hover {
    background-color: #4338CA;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    color: white;
    text-decoration: none;
  }

  .popup-more-btn:active {
    transform: translateY(0);
    color: white;
  }

  .popup-more-btn:focus {
    outline: 2px solid #4338CA;
    outline-offset: 2px;
  }

  .popup-coin-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0;
    border-top: 1px solid rgba(0, 0, 0, 0.04);
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
  }

  .popup-coin-worksgain {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .popup-coin-worksgain-counter {
    font-size: 10px;
    font-weight: 600;
    color: #707070;
  }

  .popup-coin-give-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 144px;
    height: 40px;
    background-color: rgba(230, 230, 230, 0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 12px 16px;
    border-radius: 20px;
    border: 1px solid var(--border-color, #e0e0e0);
    cursor: pointer;
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.05);
    transition: all 0.2s ease;
  }

  .popup-coin-give-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .popup-coin-give-btn:not(.disabled):hover {
    background-color: rgba(240, 240, 240, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .popup-coin-give-btn:not(.disabled):active {
    transform: translateY(0);
  }

  .popup-coin-give-btn-text {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-color, #333);
  }

  .popup-coin-give-btn-icon {
    width: 20px;
    height: 20px;
    margin-left: 4px;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
  }
  
  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
  .popup-coin-give-btn.loading {
    pointer-events: none;
    opacity: 0.7;
  }
  
  .popup-coin-give-btn .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: var(--text-color, #333);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  html.dark-theme .popup-coin-give-btn .loading-spinner {
    border-top-color: var(--text-color, #e0e0e0);
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
  html.dark-theme .work-popup {
    background-color: rgba(30, 30, 35, 0.92);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 
                0 5px 10px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  html.dark-theme .popup-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  html.dark-theme .popup-header h3 {
    color: #F9FAFB;
  }

  html.dark-theme .popup-close-button {
    color: #9CA3AF;
  }

  html.dark-theme .popup-close-button:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #F3F4F6;
  }

  html.dark-theme .popup-image-container {
    background-color: rgba(17, 24, 39, 0.8);
    color: #6B7280;
  }

  html.dark-theme .popup-meta span {
    background-color: rgba(79, 70, 229, 0.15);
    color: #A5B4FC;
  }

  html.dark-theme #popupDescription {
    color: #D1D5DB;
  }

  html.dark-theme .popup-footer {
    border-top: 1px solid rgba(255, 255, 255, 0.08);
  }

  html.dark-theme .popup-close-btn {
    background-color: rgba(55, 65, 81, 0.5);
    color: #E5E7EB;
  }

  html.dark-theme .popup-more-btn {
    background-color: #5850EC;
  }

  html.dark-theme .popup-close-btn:hover {
    background-color: rgba(75, 85, 99, 0.5);
  }

  html.dark-theme .popup-more-btn:hover {
    background-color: #6366F1;
  }


  /* åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  /* TODO: åºƒå‘ŠãŒé©ç”¨ã•ã‚ŒãŸã‚‰display: none;ã‚’å‰Šé™¤ã™ã‚‹ */
  .point-bubble.ad-item {
    display: none; /* åºƒå‘Šæœªé©ç”¨ã®ãŸã‚ä¸€æ™‚çš„ã«éè¡¨ç¤º */
    width: 50px;
    height: 50px;
    overflow: visible;
    position: absolute;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.8), rgba(255, 165, 0, 0.8));
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.8);
    border: 2px solid rgba(255, 215, 0, 0.9);
  }

  .point-bubble.ad-item::before {
    width: 8px;
    height: 8px;
    background-color: rgba(255, 255, 255, 0.95);
    z-index: 2;
  }

  .point-bubble.ad-item::after {
    width: 40px;
    height: 40px;
    border: 2px solid rgba(255, 215, 0, 0.7);
    animation: adPulse 4s infinite ease-out;
    z-index: 1;
  }

  .point-bubble.ad-item:hover {
    transform: translate(-50%, -50%) translateZ(8px) scale(1.1);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(255, 165, 0, 0.9));
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), inset 0 0 15px rgba(255, 255, 255, 1);
  }

  .ad-icon {
    width: 90%;
    aspect-ratio: 1/1;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    position: relative;
    z-index: 3;
  }

  @keyframes adPulse {
    0% {
      width: 40px;
      height: 40px;
      opacity: 0.7;
      border-width: 2px;
    }
    50% {
      width: 80px;
      height: 80px;
      opacity: 0.2;
      border-width: 1px;
    }
    100% {
      width: 40px;
      height: 40px;
      opacity: 0.7;
      border-width: 2px;
    }
  }

  /* åºƒå‘Šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .ad-popup {
    position: fixed;
    left: 4%;
    top: 50%;
    transform: translateY(-50%) translateX(-4%);
    width: 30%;
    background-color: rgba(255, 255, 255, 0.85);
    border-radius: 32px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    padding: 16px 24px;
  }

  .ad-popup.active {
    transform: translateY(-50%) translateX(0);
  }

  .ad-prompt {
    width: 100%;
    min-height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 16px;
    margin-bottom: 16px;
    text-align: center;
  }

  .ad-prompt p {
    font-size: 0.8rem;
    color: var(--text-color, #4B5563);
    margin: 0;
  }

  .ad-container {
    width: 100%;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
  }

  .custom-ad-container {
    width: 100%;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
  }

  .ad-view-btn {
    padding: 9px 16px;
    border-radius: 16px;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    background-color: #4F46E5;
    color: white;
    flex: 2;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  }

  .ad-view-btn:hover {
    background-color: #4338CA;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .ad-view-btn:active {
    transform: translateY(0);
  }

  html.dark-theme .ad-view-btn {
    background-color: #5850EC;
  }

  html.dark-theme .ad-view-btn:hover {
    background-color: #6366F1;
  }

  html.dark-theme .ad-prompt p {
    color: #D1D5DB;
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
  html.dark-theme .ad-popup {
    background-color: rgba(30, 30, 35, 0.92);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 
                0 5px 10px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  html.dark-theme .point-bubble.ad-item {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.7), rgba(255, 165, 0, 0.7));
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.6);
  }

  /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .ad-popup {
      left: 50%;
      right: auto;
      width: calc(100% - 40px);
      max-width: 300px;
      transform: translateX(-50%) translateY(-50%);
    }
    
    .ad-popup.active {
      transform: translateX(-50%) translateY(-50%);
    }
  }

  /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .work-popup {
      left: 50%;
      right: auto;
      width: calc(100% - 40px);
      max-width: 300px;
      transform: translateX(-50%) translateY(-50%);
    }
    
    .work-popup.active {
      transform: translateX(-50%) translateY(-50%);
    }
    
    /* ãƒã‚¤ãƒ³ãƒˆã®ã‚µã‚¤ã‚ºã‚’å°ã•ã */
    .point-bubble {
      width: 28px;
      height: 28px;
    }
    
    .point-bubble::before {
      width: 8px;
      height: 8px;
    }
    
    .point-bubble::after {
      width: 48px;
      height: 48px;
    }
    
    .point-bubble:not(.work-item)::before {
      width: 6px;
      height: 6px;
    }
    
    .point-bubble:not(.work-item)::after {
      width: 40px;
      height: 40px;
    }
    
    .point-bubble.work-item {
      width: 40px;
      height: 40px;
    }
    
    .point-bubble.work-item::before {
      width: 5px;
      height: 5px;
    }
    
    .point-bubble.work-item::after {
      width: 32px;
      height: 32px;
    }
    
    .point-bubble.ad-item {
      width: 40px;
      height: 40px;
    }
    
    .point-bubble.ad-item::before {
      width: 6px;
      height: 6px;
    }
    
    .point-bubble.ad-item::after {
      width: 32px;
      height: 32px;
    }
    
    /* åºƒå‘Šã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚å°ã•ã */
    .ad-icon {
      font-size: 18px;
    }
    
    /* åºƒå‘Šãƒã‚¤ãƒ³ãƒˆã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚µã‚¤ã‚ºã‚‚èª¿æ•´ */
    .point-bubble.ad-item {
      border-width: 1.5px;
    }

    .ad-prompt {
      margin-top: 0;
    }
  }

  /* ãƒã‚¤ãƒ³ãƒˆé…ç½®ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒã‚¤ãƒ³ãƒˆä½ç½® - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ã—ã¦åŸºæœ¬ä½ç½®ã‚’è¨­å®š */
  .point-1 { left: 30%; top: 30%; animation-delay: 0s; }
  .point-2 { left: 70%; top: 30%; animation-delay: 0.4s; }
  .point-3 { left: 35%; top: 45%; animation-delay: 0.8s; }
  .point-4 { left: 65%; top: 45%; animation-delay: 1.2s; }
  .point-5 { left: 30%; top: 65%; animation-delay: 1.6s; }
  .point-6 { left: 70%; top: 65%; animation-delay: 2s; }
  .point-7 { left: 50%; top: 30%; animation-delay: 2.4s; }
  .point-8 { left: 40%; top: 60%; animation-delay: 2.8s; }
  .point-9 { left: 60%; top: 60%; animation-delay: 3.2s; }
  .point-10 { left: 35%; top: 80%; animation-delay: 3.6s; }
  .point-11 { left: 65%; top: 80%; animation-delay: 4s; }
  .point-12 { left: 50%; top: 50%; animation-delay: 4.4s; }
  .point-13 { left: 25%; top: 50%; animation-delay: 4.8s; }
  .point-14 { left: 75%; top: 50%; animation-delay: 5.2s; }
  .point-15 { left: 20%; top: 70%; animation-delay: 5.6s; }
  .point-16 { left: 80%; top: 70%; animation-delay: 6.0s; }

  /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶ã®åŸºæœ¬è¨­å®š */
  .point-1, .point-2, .point-3, .point-4, .point-5, .point-6,
  .point-7, .point-8, .point-9, .point-10, .point-11, .point-12,
  .point-13, .point-14, .point-15, .point-16 {
    animation-delay: 0s;
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ« - point-1ã‚’ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦ç‰¹åˆ¥æ‰±ã„ */
  .town-profile .point-1 {
    left: 36%; 
    top: 90%;
    animation-delay: 0s;
  }

  /* ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç›´æ¥è¡¨ç¤ºã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ */
  .profile-card {
    position: absolute;
    width: 200px;
    padding: 24px;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-100%);
    z-index: 20;
  }

  .profile-card .profile-name {
    font-size: 16px;
    font-weight: 600;
    color: #252528;
    margin: 0 0 8px;
    padding: 0 8px;
  }

  .profile-card .profile-name-sub {
    font-size: 12px;
    margin: 0 0 16px;
    line-height: 1.5;
  }

  .profile-card .profile-text {
    font-size: 10px;
    color: #66666d;
    margin: 0 0 16px;
    line-height: 1.8;
    padding: 0 8px;
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
  html.dark-theme .profile-card {
    border-color: rgba(70, 70, 90, 0.5);
  }

  html.dark-theme .profile-card .profile-name {
    color: #e0e0e0;
  }

  html.dark-theme .profile-card .profile-text {
    color: #aaa;
  }

  .profile-card .profile-image-popup {
    position: absolute;
    left: -280px;
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 220px;
    background-color: rgba(255, 255, 255, 0.92);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 30;
    padding: 15px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.8);
    pointer-events: auto;
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è¡¨ç¤ºè¨­å®š - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã®ã¿è¡¨ç¤º */
  .profile-card .profile-image-popup.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(-50%) scale(1);
    left: -280px;
  }

  /* ãƒ›ãƒãƒ¼æ™‚ã®è¡¨ç¤ºè¨­å®šã‚’å‰Šé™¤ */
  /* .profile-card .profile-image:hover + .profile-image-popup,
  .profile-card .profile-image-popup:hover {
    opacity: 1;
    visibility: visible;
    transform: translateY(-50%) scale(1);
    left: -280px;
  } */

  .profile-card .profile-image-popup img {
    width: 100%;
    border-radius: 10px;
    transform: scale(1.05);
    filter: blur(0.5px);
    transition: all 0.3s ease;
  }

  .profile-card .profile-image-popup h3 {
    font-size: 16px;
    margin: 12px 0 5px;
    color: #333;
  }

  .profile-card .profile-image-popup p {
    font-size: 12px;
    color: #666;
    margin: 0;
    line-height: 1.4;
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
  html.dark-theme .profile-card {

    border-color: rgba(70, 70, 90, 0.5);

  }

  html.dark-theme .profile-card .profile-image {
    border-color: rgba(50, 50, 60, 1);
  }

  html.dark-theme .profile-card .profile-name {
    color: #e0e0e0;
  }

  html.dark-theme .profile-card .profile-text {
    color: #aaaaaa;
  }

  .profile-card .profile-image-popup {
    position: absolute;
    left: -250px;
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 220px;
    background-color: rgba(255, 255, 255, 0.92);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 30;
    padding: 15px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.8);
    pointer-events: none; /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è‡ªä½“ã«ã¯ãƒ›ãƒãƒ¼ã§ããªã„ã‚ˆã†ã« */
  }

  .profile-image-popup img {
    width: 100%;
    border-radius: 10px;
    transform: scale(1.05);
    filter: blur(0.5px);
    transition: all 0.3s ease;
  }

  .profile-image-popup h3 {
    font-size: 16px;
    margin: 12px 0 5px;
    color: #333;
  }

  .profile-image-popup p {
    font-size: 12px;
    color: #666;
    margin: 0;
    line-height: 1.4;
  }

  

  /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .profile-card {
      width: 90%;
      max-width: 320px;
      padding: 16px;
    }
    
    .profile-card .profile-image {
      width: 100px;
      height: 100px;
    }
    
    .profile-card .profile-name {
      font-size: 20px;
    }
    
    .profile-card .profile-text {
      font-size: 14px;
    }
    
    .profile-skills li {
      font-size: 12px;
      padding: 4px 10px;
    }
  }

  /* SNSãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .profile-sns-list {
    display: flex;
    justify-content: center;
    gap: 8px;
    list-style: none;
    padding: 0;
    margin: 16px 0;
    width: 100%;
  }

  .profile-sns-item {
    flex: 1;
    position: relative;
    transform-style: preserve-3d;
  }

  .profile-sns-link {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    border-radius: 18px;
    background-color: #e0e0e0;
    border: 1px solid #fff;
    color: #4285f4;
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    position: relative;
    z-index: 2;
    flex: 1;
    
  }

  .profile-sns-link:hover {
    background: linear-gradient(135deg, rgba(230, 244, 255, 0.95), rgba(190, 230, 255, 0.8));
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 6px 12px rgba(100, 180, 255, 0.3), inset 0 1px 2px rgba(255, 255, 255, 0.8);
    color: #2c6fdb;
  }

  @keyframes snsPulse {
    0% {
      opacity: 0.7;
      transform: scale(0.98);
      box-shadow: 0 0 0 0 rgba(100, 180, 255, 0.4);
    }
    50% {
      opacity: 0.3;
      transform: scale(1.07);
      box-shadow: 0 0 0 8px rgba(100, 180, 255, 0);
    }
    100% {
      opacity: 0.7;
      transform: scale(0.98);
      box-shadow: 0 0 0 0 rgba(100, 180, 255, 0);
    }
  }

  .sns-icon {
    position: relative;
    z-index: 2;
    filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
  }

  html.dark-theme .profile-sns-link {
    color: #a5c4ff;
    border: 1px solid rgba(100, 140, 200, 0.3);
  }

  html.dark-theme .profile-sns-link:hover {
    color: #d5e3ff;
  }

  html.dark-theme .profile-sns-link::after {
    border: 1px solid rgba(100, 140, 200, 0.4);
    background: radial-gradient(circle at center, rgba(100, 150, 220, 0.2) 0%, transparent 70%);
  }

  .profile-card .profile-image {
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 16px;
    margin: 0 auto 16px;
    background-size: cover;
    background-position: center;
    border: 1px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: visible;
    z-index: 10; /* z-indexã‚’ã•ã‚‰ã«é«˜ãã—ã¦ä»–è¦ç´ ã‚ˆã‚Šå‰é¢ã«è¡¨ç¤º */
    cursor: pointer !important; /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å›ºå®š */
    pointer-events: auto; /* ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹åŒ– */
    /* will-change: transform; ãƒ›ãƒãƒ¼æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ */
  }

  .profile-card .profile-image::after {
    content: '';
    position: absolute;
    width: 105%;
    height: 105%;
    border-radius: 16px;
    border: 1px solid rgba(180,190,255,0.7);
    top: -2.5%;
    left: -2.5%;
    z-index: -1;
    animation: profilePulse 4s infinite ease-out;
    pointer-events: none; /* ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®Œå…¨ã«é€é */
    box-shadow: 0 0 50px rgba(120, 180, 255, 0.6), 
               inset 0 0 30px rgba(140, 210, 255, 0.5);
    border-color: rgba(180, 190, 255, 1);
    background-color: rgba(120, 180, 255, 0.6);
    filter: blur(4px);
    transform: translateZ(-1px);
    /* transform-origin: center center; å¤‰å½¢ã®åŸºæº–ç‚¹ã‚’ä¸­å¤®ã«å›ºå®š */
  }

  @keyframes profilePulse {
    0% {
      opacity: 0.7;
      transform: scale(.9) translateZ(-1px);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2), 
                 inset 0 0 10px rgba(255, 255, 255, 0.2);
    }
    50% {
      opacity: 0.4;
      transform: scale(1.1) translateZ(-1px);
      box-shadow: 0 0 0 5px rgba(255, 255, 255, 0), 
                 inset 0 0 20px rgba(255, 255, 255, 0.1);
    }
    100% {
      opacity: 0.7;
      transform: scale(.9) translateZ(-1px);
      box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.2), 
                 inset 0 0 10px rgba(255, 255, 255, 0.2);
    }
  }

  .profile-card .profile-image:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    cursor: pointer !important; /* ãƒ›ãƒãƒ¼æ™‚ã«ã‚‚ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã«å›ºå®š */
  }

  .profile-card .profile-image:hover::after {
    filter: blur(6px);
    background-color: rgba(120, 180, 255, 0.7);
  }

  html.dark-theme .profile-card .profile-image {
    border-color: rgba(50, 50, 60, 1);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  /* ========================================
     Coin System
     ======================================== */
  :global(.coins-container) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 20;
    transform-style: flat; /* 3D transformã®å½±éŸ¿ã‚’å—ã‘ãªã„ã‚ˆã†ã« */
  }

  :global(.coin) {
    position: absolute;
    width: 28px;
    height: 28px;
    transform: translate(-50%, -50%);
    z-index: 20;
    pointer-events: auto;
    cursor: pointer;
    animation: coinFloat 2s ease-in-out infinite;
    transform-style: preserve-3d;
    transition: opacity 1.2s ease-in;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ã‚³ã‚¤ãƒ³ç”Ÿæˆæ™‚ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ */
  :global(.coin.coin-spawning) {
    opacity: 0;
    animation: coinFadeIn 1.2s ease-in forwards, coinFloat 2s ease-in-out 1.2s infinite;
  }

  /* å›è»¢ç”¨ãƒ©ãƒƒãƒ‘ãƒ¼ */
  :global(.coin-rotate-wrapper) {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ã‚³ã‚¤ãƒ³ç”»åƒ */
  :global(.coin .coin-image) {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  :global(.coin:hover) {
    transform: translate(-50%, -50%) scale(1.15);
  }

  :global(.coin:hover .coin-image) {
    filter: drop-shadow(0 4px 8px rgba(255, 215, 0, 0.6)) drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  /* ãƒãƒªã‚ªé¢¨ã®å–å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  :global(.coin.collected) {
    animation: coinCollectMove 0.8s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
    pointer-events: none;
  }

  :global(.coin.collected .coin-rotate-wrapper) {
    animation: coinCollectRotate 0.8s linear forwards;
  }

  @keyframes coinFloat {
    0%, 100% {
      transform: translate(-50%, -50%) translateY(0) rotateY(0deg);
    }
    50% {
      transform: translate(-50%, -50%) translateY(-4px) rotateY(5deg);
    }
  }

  /* å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸€å®šé€Ÿåº¦ã€é«˜é€Ÿï¼‰ */
  @keyframes coinCollectRotate {
    0% {
      transform: rotateZ(0deg);
    }
    80% {
      transform: rotateZ(360deg);
    }
    100% {
      transform: rotateZ(0);
    }
  }

  /* ä¸Šä¸‹ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç·©æ€¥ã‚ã‚Šï¼‰ */
  @keyframes coinCollectMove {
    0% {
      opacity: 1;
      transform: translate(-50%, -50%) translateY(0);
    }
    30% {
      opacity: 1;
      transform: translate(-50%, -50%) translateY(-50px);
    }
    50% {
      opacity: 1;
      transform: translate(-50%, -50%) translateY(-50px);
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) translateY(-40px);
    }
  }

  @keyframes coinFadeIn {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
  }

  :global(html.dark-theme .coin .coin-image) {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5)) brightness(1.1);
  }

  /* ã‚³ã‚¤ãƒ³æ•°è¡¨ç¤ºUIã¨ãƒœãƒ¼ãƒŠã‚¹ä¸­UIã®ã‚³ãƒ³ãƒ†ãƒŠ */
  .coin-counter-wrapper {
    position: fixed;
    top: 60px; /* header-containerã®é«˜ã•ï¼ˆpadding: 16px 40px 8pxï¼‰ã‚’è€ƒæ…® */
    left: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1001;
    transition: all 0.2s ease;
  }
  
  /* ã‚³ã‚¤ãƒ³æ•°è¡¨ç¤ºUI */
  .coin-counter {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-color, #333);
    transition: all 0.2s ease;
  }
  
  /* ãƒœãƒ¼ãƒŠã‚¹ä¸­UI - ã‚³ã‚¤ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¨æ¨ªä¸¦ã³ã«é…ç½® */
  .bonus-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    font-size: 11px;
    font-weight: 600;
    color: #ff6b00;
    background-color: rgba(255, 107, 0, 0.1);
    border: 1px solid rgba(255, 107, 0, 0.3);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    transition: all 0.2s ease;
  }
  
  html.dark-theme .bonus-indicator {
    color: #ff8c42;
    background-color: rgba(255, 140, 66, 0.15);
    border-color: rgba(255, 140, 66, 0.4);
  }
  
  .bonus-label {
    font-size: 10px;
    font-weight: 600;
  }
  
  .bonus-time {
    font-size: 11px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
  }

  html.dark-theme .coin-counter {
    color: var(--text-color, #e0e0e0);
  }

  .coin-icon {
    width: 24px;
    height: 24px;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
  }

  .coin-count-label {
    font-size: 11px;
    font-weight: 500;
    color: var(--text-color, #e0e0e0);
    text-align: center;
  }

  .coin-count-text {
    font-size: 12px;
    font-weight: 600;
    text-align: center;
  }

  /* ã‚³ã‚¤ãƒ³å–å¾—æ™‚ã®ã€Œ+1ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  :global(.coin-gain-indicator) {
    position: fixed;
    font-size: 11px;
    font-weight: 600;
    color: #000000;
    z-index: 10000;
    opacity: 0;
    transform: translateY(0) scale(0.8);
    pointer-events: none;
    white-space: nowrap;
    user-select: none;
    will-change: transform, opacity;
  }

  :global(.coin-gain-indicator.active) {
    animation: coinGainFloat 1s ease-out forwards;
  }

  @keyframes coinGainFloat {
    0% {
      opacity: 0;
      transform: translateY(-2px) scale(0.8);
    }
    30% {
      opacity: 1;
      transform: translateY(-6px) scale(1);
    }
    100% {
      opacity: 0;
      transform: translateY(-10dpx) scale(0.9);
    }
  }a

  :global(html.dark-theme .coin-gain-indicator) {
    color: #ffffff;
  }

  /* ã‚³ã‚¤ãƒ³ãŒç”»é¢ã«æº¢ã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
  :global(.coin-burst) {
    position: fixed;
    width: 64px;
    height: 64px;
    z-index: 10001;
    pointer-events: none;
    opacity: 0;
    transform: translate(-50%, -50%);
    will-change: transform, opacity;
  }

  :global(.coin-burst.active) {
    animation: coinBurstAnimation 1.3s ease-out forwards;
  }

  :global(.coin-burst-image) {
    width: 100%;
    height: 100%;
    object-fit: contain;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
    image-rendering: crisp-edges;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
  }

  @keyframes coinBurstAnimation {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) translate(0, 0);
    }
    5% {
      opacity: 1;
      transform: translate(-50%, -50%) translate(0, 0);
    }
    100% {
      opacity: 0;
      transform: translate(-50%, -50%) translate(var(--delta-x, 0px), var(--delta-y, 0px));
    }
  }

  /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .coin-counter-wrapper {
      top: 48px;
      left: 16px;
      gap: 8px;
    }
    
    .coin-counter {
      margin: 0;
      padding: 3px 0;
      gap: 5px;
    }
    
    .bonus-indicator {
      padding: 3px 6px;
      gap: 4px;
      font-size: 10px;
    }
    
    .bonus-label {
      font-size: 9px;
    }
    
    .bonus-time {
      font-size: 10px;
    }

    .coin-icon {
      width: 24px;
      height: 24px;
    }

    .coin-count-text {
      font-size: 11px;
    }

    .coin-gain-indicator {
      font-size: 10px;
      margin-left: 4px;
    }
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« - worksã‚¿ã‚¦ãƒ³ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¨åŒæ§˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .profile-popup {
    position: fixed;
    left: 4%;
    top: 50%;
    transform: translateY(-50%) translateX(-4%);
    width: 30%;
    background-color: rgba(255, 255, 255, 0.85);
    border-radius: 32px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    padding: 16px 24px;
  }

  .profile-popup.active {
    transform: translateY(-50%) translateX(0);
  }

  .profile-image-large {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒå¯¾å¿œ */
  html.dark-theme .profile-popup {
    background-color: rgba(30, 30, 35, 0.92);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2), 
                0 5px 10px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
  }

  html.dark-theme .profile-popup .popup-header h3 {
    color: #F9FAFB;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
  @media (max-width: 768px) {
    .profile-popup {
      left: 50%;
      right: auto;
      width: calc(100% - 40px);
      max-width: 300px;
      transform: translateX(-50%) translateY(-50%);
    }
    
    .profile-popup.active {
      transform: translateX(-50%) translateY(-50%);
    }
  }
  
  /* æ—¢å­˜ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾æ®‹ã™ */
  .profile-card .profile-image-popup {
    position: absolute;
    left: -280px;
    top: 50%;
    transform: translateY(-50%) scale(0.8);
    width: 220px;
    background-color: rgba(255, 255, 255, 0.92);
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    z-index: 30;
    padding: 15px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.8);
    pointer-events: auto;
    display: none; /* éè¡¨ç¤ºã«å¤‰æ›´ */
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”¨ã®ãƒã‚¤ãƒ³ãƒˆ */
  .profile-card .profile-point {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 35px;
    height: 35px;
    cursor: pointer;
    z-index: 30;
  }

  .profile-card .point-title {
    position: absolute;
    width: 100px;
    left: 50%;
    transform: translateX(-50%);
    top: -24px;
    text-align: center;
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-color);
    opacity: 0;
    transition: opacity 0.3s ease, transform 0.3s ease;
    background-color: rgba(255, 255, 255, 0.85);
    padding: 2px 6px;
    border-radius: 10px;
    pointer-events: none;
  }

  .profile-card .profile-point:hover .point-title {
    opacity: 1;
    transform: translateX(-50%) translateY(-5px);
  }

  /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
  .profile-card .profile-image {
    width: 100%;
    aspect-ratio: 4/3;
    border-radius: 16px;
    margin: 0 auto 16px;
    background-size: cover;
    background-position: center;
    border: 1px solid white;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    overflow: visible;
    z-index: 10;
    cursor: default; /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«å¤‰æ›´ */
    pointer-events: auto;
  }

  .profile-card .profile-image:hover {
    transform: none; /* ãƒ›ãƒãƒ¼æ™‚ã®æ‹¡å¤§ã‚’ç„¡åŠ¹åŒ– */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* å…ƒã®ã‚·ãƒ£ãƒ‰ã‚¦ã‚’ç¶­æŒ */
    cursor: default;
  }
</style> 