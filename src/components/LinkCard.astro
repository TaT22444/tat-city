---
// リンクカードコンポーネント - OGP情報を表示
interface Props {
  url: string;
}

const { url } = Astro.props;

// OGP情報を取得する関数
async function fetchOGPData(url: string) {
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5秒タイムアウト
    
    const response = await fetch(url, {
      signal: controller.signal,
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; LinkCardBot/1.0; +https://tat-archive.com)'
      }
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`Failed to fetch: ${response.status}`);
    }
    
    const html = await response.text();
    
    // OGPメタタグを抽出
    const ogTitle = html.match(/<meta property="og:title" content="([^"]*)"/) || html.match(/<title>([^<]*)<\/title>/);
    const ogDescription = html.match(/<meta property="og:description" content="([^"]*)"/);
    const ogImage = html.match(/<meta property="og:image" content="([^"]*)"/);
    const ogSiteName = html.match(/<meta property="og:site_name" content="([^"]*)"/);
    
    // ファビコンを取得（フォールバック）
    const favicon = html.match(/<link[^>]*rel="(?:icon|shortcut icon)"[^>]*href="([^"]*)"/) || 
                    html.match(/<link[^>]*href="([^"]*)"[^>]*rel="(?:icon|shortcut icon)"/);
    
    return {
      title: ogTitle ? ogTitle[1] : new URL(url).hostname,
      description: ogDescription ? ogDescription[1] : '',
      image: ogImage ? ogImage[1] : '',
      siteName: ogSiteName ? ogSiteName[1] : new URL(url).hostname,
      favicon: favicon ? favicon[1] : '',
      url: url
    };
  } catch (error) {
    console.error(`Error fetching OGP data for ${url}:`, error);
    // エラー時はURLのホスト名を返す
    return {
      title: new URL(url).hostname,
      description: '',
      image: '',
      siteName: new URL(url).hostname,
      favicon: '',
      url: url
    };
  }
}

const ogpData = await fetchOGPData(url);

// 画像URLを絶対URLに変換
const getAbsoluteUrl = (imageUrl: string, baseUrl: string) => {
  if (!imageUrl) return '';
  if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
    return imageUrl;
  }
  if (imageUrl.startsWith('//')) {
    return 'https:' + imageUrl;
  }
  if (imageUrl.startsWith('/')) {
    const base = new URL(baseUrl);
    return `${base.protocol}//${base.host}${imageUrl}`;
  }
  return new URL(imageUrl, baseUrl).href;
};

const absoluteImageUrl = getAbsoluteUrl(ogpData.image, url);
const absoluteFaviconUrl = getAbsoluteUrl(ogpData.favicon, url);
---

<a href={url} target="_blank" rel="noopener noreferrer" class="link-card">
  <div class="link-card-icon">
    {absoluteFaviconUrl ? (
      <img src={absoluteImageUrl} alt="" class="link-card-favicon" loading="lazy" />
    ) : (
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    )}
  </div>
  <div class="link-card-content">
    <div class="link-card-title">{ogpData.title}</div>
    {ogpData.description && (
      <div class="link-card-description">{ogpData.description}</div>
    )}
    <div class="link-card-domain">{ogpData.siteName}</div>
  </div>
</a>

<style is:global>
  .link-card {
    display: flex;
    align-items: center;
    gap: 32px;
    text-decoration: none;
    border: 1px solid var(--color-background-gray);
    border-radius: 16px;
    padding: 32px;
    transition: all 0.2s ease;
    background-color: var(--color-background-gray);
    margin: 1.5em 0;
    color: inherit;
    width: calc(100% - 64px);
    max-width: 100%;
    min-height: 80px;
  }

  .link-card:hover {
    border-color: var(--color-border-light);
    box-shadow: 0 0 32px rgba(0, 0, 0, 0.08);
  }

  .link-card-icon {
    flex-shrink: 0;
    width: 56px;
    height: 56px;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--color-white);
    border-radius: 16px;
    overflow: hidden;
  }

  .link-card-icon svg {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    color: var(--color-text-tertiary);
  }

  .link-card-favicon {
    width: 100%;
    height: 100%;
    border-radius: 12px;
    object-fit: contain;
  }

  .link-card-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 0;
    overflow: hidden;
  }

  .link-card-title {
    font-size: 15px;
    font-weight: 600;
    color: var(--color-text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    line-height: 1.4;
  }

  .link-card-description {
    font-size: 13px;
    color: var(--color-text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.5;
  }

  .link-card-domain {
    font-size: 11px;
    color: var(--color-text-tertiary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    .link-card {
      width: calc(100% - 32px);
      padding: 14px 16px;
      gap: 12px;
    }

    .link-card-icon {
      width: 56px;
      height: 56px;
      padding: 0;
    }

    .link-card-icon svg {
    }

    .link-card-favicon {
    }

    .link-card-title {
      font-size: 14px;
      -webkit-line-clamp: 2;
    }

    .link-card-description {
      font-size: 12px;
    }

    .link-card-domain {
      font-size: 10px;
    }
  }
</style>
